<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <title>nasldoc: nasl</title> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="description" content=""> <meta name="author" content=""> <style type="text/css">
	body {
	padding-top: 60px;
	padding-bottom: 40px;
	}
	.sidebar-nav {
	padding: 9px 0;
	}
  </style> <link href="css/bootstrap.min.css" rel="stylesheet"> <link href="css/shCore.css" rel="stylesheet" type="text/css"/> <link href="css/shThemeDefault.css" rel="stylesheet" type="text/css"/> <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--> <link rel="shortcut icon" href="ico/favicon.ico"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png"> </head> <body> <div class="navbar navbar-inverse navbar-fixed-top"> <div class="navbar-inner"> <div class="container-fluid"> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="index.html">nasldoc</a> <div class="nav-collapse collapse"> <ul class="nav"> <li class="active"><a href="index.html">Home</a></li> </ul> </div> </div> </div> </div> <div class="container-fluid"> <div class="row-fluid"> <div class="span3"> <div class="well sidebar-nav"> <ul class="nav nav-list"> <li class="even"> <a href="GSHB_BruteForce.html">GSHB_BruteForce.inc</a> </li> <li class="odd"> <a href="GSHB_read_file.html">GSHB_read_file.inc</a> </li> <li class="even"> <a href="bad_ssh_host_keys.html">bad_ssh_host_keys.inc</a> </li> <li class="odd"> <a href="bad_ssh_keys.html">bad_ssh_keys.inc</a> </li> <li class="even"> <a href="bin.html">bin.inc</a> </li> <li class="odd"> <a href="byte_func.html">byte_func.inc</a> </li> <li class="even"> <a href="cisco_ios.html">cisco_ios.inc</a> </li> <li class="odd"> <a href="cpe.html">cpe.inc</a> </li> <li class="even"> <a href="default_account.html">default_account.inc</a> </li> <li class="odd"> <a href="default_credentials.html">default_credentials.inc</a> </li> <li class="even"> <a href="dump.html">dump.inc</a> </li> <li class="odd"> <a href="ftp_func.html">ftp_func.inc</a> </li> <li class="even"> <a href="gb_openssl_heartbeat.html">gb_openssl_heartbeat.inc</a> </li> <li class="odd"> <a href="global_settings.html">global_settings.inc</a> </li> <li class="even"> <a href="gvr_apps_auth_func.html">gvr_apps_auth_func.inc</a> </li> <li class="odd"> <a href="host_details.html">host_details.inc</a> </li> <li class="even"> <a href="hp_printers.html">hp_printers.inc</a> </li> <li class="odd"> <a href="http_func.html">http_func.inc</a> </li> <li class="even"> <a href="http_keepalive.html">http_keepalive.inc</a> </li> <li class="odd"> <a href="imap_func.html">imap_func.inc</a> </li> <li class="even"> <a href="itg.html">itg.inc</a> </li> <li class="odd"> <a href="junos.html">junos.inc</a> </li> <li class="even"> <a href="kyocera_printers.html">kyocera_printers.inc</a> </li> <li class="odd"> <a href="ldap.html">ldap.inc</a> </li> <li class="even"> <a href="lexmark_printers.html">lexmark_printers.inc</a> </li> <li class="odd"> <a href="misc_func.html">misc_func.inc</a> </li> <li class="even"> <a href="netop.html">netop.inc</a> </li> <li class="odd"> <a href="network_func.html">network_func.inc</a> </li> <li class="even"> <a href="nfs_func.html">nfs_func.inc</a> </li> <li class="odd"> <a href="nmap.html">nmap.inc</a> </li> <li class="even"> <a href="nntp_func.html">nntp_func.inc</a> </li> <li class="odd"> <a href="os_eol.html">os_eol.inc</a> </li> <li class="even"> <a href="pingpong.html">pingpong.inc</a> </li> <li class="odd"> <a href="pkg-lib-bsd.html">pkg-lib-bsd.inc</a> </li> <li class="even"> <a href="pkg-lib-deb.html">pkg-lib-deb.inc</a> </li> <li class="odd"> <a href="pkg-lib-gentoo.html">pkg-lib-gentoo.inc</a> </li> <li class="even"> <a href="pkg-lib-hpux.html">pkg-lib-hpux.inc</a> </li> <li class="odd"> <a href="pkg-lib-macosx.html">pkg-lib-macosx.inc</a> </li> <li class="even"> <a href="pkg-lib-rpm.html">pkg-lib-rpm.inc</a> </li> <li class="odd"> <a href="pkg-lib-slack.html">pkg-lib-slack.inc</a> </li> <li class="even"> <a href="pop3_func.html">pop3_func.inc</a> </li> <li class="odd"> <a href="revisions-lib.html">revisions-lib.inc</a> </li> <li class="even"> <a href="rsync_func.html">rsync_func.inc</a> </li> <li class="odd"> <a href="secpod_activex.html">secpod_activex.inc</a> </li> <li class="even"> <a href="secpod_ie_supersede.html">secpod_ie_supersede.inc</a> </li> <li class="odd"> <a href="secpod_reg.html">secpod_reg.inc</a> </li> <li class="even"> <a href="secpod_smb_func.html">secpod_smb_func.inc</a> </li> <li class="odd"> <a href="secpod_ssl_ciphers.html">secpod_ssl_ciphers.inc</a> </li> <li class="even"> <a href="sharp_printers.html">sharp_printers.inc</a> </li> <li class="odd"> <a href="sip.html">sip.inc</a> </li> <li class="even"> <a href="smb_default_credentials.html">smb_default_credentials.inc</a> </li> <li class="odd"> <a href="smb_nt.html">smb_nt.inc</a> </li> <li class="even"> <a href="smbcl_func.html">smbcl_func.inc</a> </li> <li class="odd"> <a href="smtp_func.html">smtp_func.inc</a> </li> <li class="even"> <a href="snmp_func.html">snmp_func.inc</a> </li> <li class="odd"> <a href="solaris.html">solaris.inc</a> </li> <li class="even"> <a href="ssh_func.html">ssh_func.inc</a> </li> <li class="odd"> <a href="ssl_funcs.html">ssl_funcs.inc</a> </li> <li class="even"> <a href="telnet_func.html">telnet_func.inc</a> </li> <li class="odd"> <a href="tftp.html">tftp.inc</a> </li> <li class="even"> <a href="uddi.html">uddi.inc</a> </li> <li class="odd"> <a href="url_func.html">url_func.inc</a> </li> <li class="even"> <a href="version_func.html">version_func.inc</a> </li> <li class="odd"> <a href="vmware_esx.html">vmware_esx.inc</a> </li> <li class="even"> <a href="wmi_file.html">wmi_file.inc</a> </li> <li class="odd"> <a href="wmi_hardware.html">wmi_hardware.inc</a> </li> <li class="even"> <a href="wmi_misc.html">wmi_misc.inc</a> </li> <li class="odd"> <a href="wmi_os.html">wmi_os.inc</a> </li> <li class="even"> <a href="wmi_proc.html">wmi_proc.inc</a> </li> <li class="odd"> <a href="wmi_rsop.html">wmi_rsop.inc</a> </li> <li class="even"> <a href="wmi_svc.html">wmi_svc.inc</a> </li> <li class="odd"> <a href="wmi_user.html">wmi_user.inc</a> </li> <li class="even"> <a href="wordlist.html">wordlist.inc</a> </li> <li class="odd"> <a href="xerox_printers.html">xerox_printers.inc</a> </li> <li class="even"> <a href="xml.html">xml.inc</a> </li> </ul> </div> </div> <div class="span9"> <a name="top"></a> <h1>Overview of misc_func.inc</h1> <h1>Public Function Summary</h1> <p>Public functions are intended to be called by the code that imports this library.</p> <table class="nopad"> <tr class="TableHeadingColor"> <th>Name</th> <th>Summary</th> </tr> <tr> <td><a href="#add_port_in_list">add_port_in_list</a></td> <td></td> </tr> <tr> <td><a href="#base64">base64</a></td> <td></td> </tr> <tr> <td><a href="#base64_code">base64_code</a></td> <td></td> </tr> <tr> <td><a href="#base64_decode">base64_decode</a></td> <td></td> </tr> <tr> <td><a href="#construct_rpc_packet">construct_rpc_packet</a></td> <td></td> </tr> <tr> <td><a href="#cvsdate2unixtime">cvsdate2unixtime</a></td> <td></td> </tr> <tr> <td><a href="#dec2hex">dec2hex</a></td> <td></td> </tr> <tr> <td><a href="#get_mariadb_version">get_mariadb_version</a></td> <td></td> </tr> <tr> <td><a href="#get_mysql_version">get_mysql_version</a></td> <td></td> </tr> <tr> <td><a href="#get_port_for_service">get_port_for_service</a></td> <td></td> </tr> <tr> <td><a href="#get_rpc_port">get_rpc_port</a></td> <td></td> </tr> <tr> <td><a href="#get_service_banner_line">get_service_banner_line</a></td> <td></td> </tr> <tr> <td><a href="#get_unknown_banner">get_unknown_banner</a></td> <td></td> </tr> <tr> <td><a href="#get_unknown_svc">get_unknown_svc</a></td> <td></td> </tr> <tr> <td><a href="#hex2raw">hex2raw</a></td> <td></td> </tr> <tr> <td><a href="#known_service">known_service</a></td> <td></td> </tr> <tr> <td><a href="#pow2">pow2</a></td> <td></td> </tr> <tr> <td><a href="#rand_str">rand_str</a></td> <td></td> </tr> <tr> <td><a href="#register_service">register_service</a></td> <td></td> </tr> <tr> <td><a href="#report_service">report_service</a></td> <td></td> </tr> <tr> <td><a href="#service_is_unknown">service_is_unknown</a></td> <td></td> </tr> <tr> <td><a href="#set_mariadb_version">set_mariadb_version</a></td> <td></td> </tr> <tr> <td><a href="#set_mysql_version">set_mysql_version</a></td> <td></td> </tr> <tr> <td><a href="#set_unknown_banner">set_unknown_banner</a></td> <td></td> </tr> <tr> <td><a href="#verify_service">verify_service</a></td> <td></td> </tr> </table> <h1>Public Function Details</h1> <h2 id="add_port_in_list">add_port_in_list</h2> <h3>Named Parameters</h3> <dl> <dt>list</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function add_port_in_list(list, port)
{
 local_var l;
 
 
 if(!get_port_state(port))
 {
  if(isnull(list))return make_list();
  else return list;
 }
 
 if(isnull(list))return make_list(port);
 
 foreach l (list)
 { 
  if(l == port)
   return list;
 }

 return make_list(list, port);
}

# hex2raw was written by Renaud?

		</pre> <a href="#top">top</a> <hr> <h2 id="base64">base64</h2> <h3>Named Parameters</h3> <dl> <dt>str</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function base64(str)
{
 local_var len, i, ret, char_count, _bits, val, cnt, mul;

 len = strlen(str);
 i = 0;
 ret = &quot;&quot;;
 char_count = 0;
 _bits = 0;
 while(i &lt; len)
 {
  _bits = _bits + ord(str[i]);
  char_count = char_count + 1;
  if(char_count == 3)
  {
    val = _bits / 262144;
    ret = string(ret, base64_code(c:val));
    val = _bits / 4096;
    val = val &amp; 0x3F;
    ret = string(ret, base64_code(c:val));
    val = _bits / 64;
    val = val &amp; 0x3F;
    ret = string(ret, base64_code(c:val));
    val = _bits &amp; 0x3F;
    ret = string(ret, base64_code(c:val));
    char_count = 0;
    _bits = 0;
 }
 else {
       _bits = _bits * 256;
       }
 i = i + 1;
 }


 if(!(char_count == 0))
 {
  cnt = char_count * 8;
  mul = 16;
  mul = mul - cnt;
  mul = pow2(x:mul);
  _bits = _bits * mul;
  val = _bits / 262144;
  ret = string(ret, base64_code(c:val));
  val = _bits / 4096;
  val = val &amp; 0x3F;
  ret = string(ret, base64_code(c:val));
 if(char_count == 1)
 { 
  ret = string(ret, &quot;==&quot;);
 }
 else
 {
   val = _bits / 64;
   val = val &amp; 0x3F;
   ret = string(ret, base64_code(c:val), &quot;=&quot;);
  }
 }
 return(ret);
}


# This function converts a string representing a decimal number to 

		</pre> <a href="#top">top</a> <hr> <h2 id="base64_code">base64_code</h2> <h3>Named Parameters</h3> <dl> <dt>c</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function base64_code(c)
{
 return(__base64_code[c]);
}

function pow2(x)

		</pre> <a href="#top">top</a> <hr> <h2 id="base64_decode">base64_decode</h2> <h3>Named Parameters</h3> <dl> <dt>key_str</dt> <dt>str</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function base64_decode(str, key_str)
{
 local_var len, i, j, k, ret, base64, b64, a,b,c,o;
 len = strlen(str);
 ret = &quot;&quot;;

 if( key_str )
   base64 = key_str;
 else
   base64 = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;

 for (i = 0; i &lt; 256; i++)
   b64[i] = 0;
 for (i = 0; i &lt; strlen(base64); i++)
   b64[ord(base64[i])] = i;

 for(j=0;j&lt;len;j+=4)
 {
   for (i = 0; i &lt; 4; i++)
   {
    c = ord(str[j+i]);
    a[i] = c;
    b[i] = b64[c];
   }
 
   o[0] = (b[0] &lt;&lt; 2) | (b[1] &gt;&gt; 4);
   o[1] = (b[1] &lt;&lt; 4) | (b[2] &gt;&gt; 2);
   o[2] = (b[2] &lt;&lt; 6) | b[3];
   if (a[2] == ord(&#39;=&#39;))
     i = 1;
   else if (a[3] == ord(&#39;=&#39;))
     i = 2;
   else
     i = 3;
   for(k=0;k&lt;i;k++)
      ret += raw_string(int(o[k]) &amp; 255);
   
   if (i &lt; 3) 
     break;
 }

 return ret;
}

__base64_code = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;

		</pre> <a href="#top">top</a> <hr> <h2 id="construct_rpc_packet">construct_rpc_packet</h2> <h3>Named Parameters</h3> <dl> <dt>credentials</dt> <dt>data</dt> <dt>procedure</dt> <dt>prog_ver</dt> <dt>program</dt> <dt>udp</dt> <dt>verifier</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function construct_rpc_packet(program, prog_ver, procedure, data, udp, credentials, verifier)
{

  ## Add 0 If credentials are not passed
  if(isnull(credentials)){
    credentials[0] = 0;
    credentials[1] = 0;
  }

  ## Add 0 If Verified are not passed
  if(isnull(verifier)){
    verifier[0] = 0;
    verifier[1] = 0;
  }

  ## Random XID
  xid = rand();

  ## Construct complete RPC Rstat Request
  header  = mkdword(xid);                       ## XID
  header += mkdword(0);                         ## Message Type: Call (0)
  header += mkdword(2);                         ## RPC Version: 2
  header += mkdword(program);                   ## Prgram
  header += mkdword(prog_ver);                  ## Prgram Version
  header += mkdword(procedure);                 ## Procedure

  ## Credentials
  cred_data = mkdword(credentials[0]);          ## Flavor
  cred_data += mkdword(strlen(credentials[1])); ## Length

  ## Verifier
  verifier_data = mkdword(verifier[0]);          ## Flavor
  verifier_data += mkdword(strlen(verifier[1])); ## Length

  rpc_packet = header + cred_data + verifier_data + data;

  ## Add Fragment header if it&#39;s not UDP protocol
  if(udp != &quot;udp&quot; || udp == FALSE)
  {
    ## Fragment Length
    data_len = strlen(header + cred_data + verifier_data + data);

    ## Fragment Header
    frag_header  = mkbyte (0x80);               ## Last Fragment
    frag_header  += mkbyte (0);                 ##
    frag_header  += mkdword(data_len);          ## Fragment Length
    rpc_packet = frag_header + rpc_packet;
  }

  return(rpc_packet);
}

#

		</pre> <a href="#top">top</a> <hr> <h2 id="cvsdate2unixtime">cvsdate2unixtime</h2> <h3>Named Parameters</h3> <dl> <dt>date</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function cvsdate2unixtime(date)
{
  local_var v, u;
  v = eregmatch(string: date, pattern: &quot;.Date: ([0-9]+)/([01][0-9])/([0-3][0-9]) ([0-2][0-9]):([0-6][0-9]):([0-6][0-9]) \$&quot;);
  if (isnull(v)) return;
  u = mktime(year: v[1], mon: v[2], mday: v[3], hour: v[3], min: v[5], sec: v[6]);
  return u;
}



		</pre> <a href="#top">top</a> <hr> <h2 id="dec2hex">dec2hex</h2> <h3>Named Parameters</h3> <dl> <dt>num</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function dec2hex(num) {
  local_var digits, hex, rem;
  hex = &quot;&quot;;

  num = int(num);
  while (num &gt; 0) {
    rem = num % 256;
    hex = raw_string(rem, hex);
    num = num / 256;
    if (num &gt; 0 &amp;&amp; num &lt; 255) {
      hex = raw_string(num, hex);
      num = 0;
    }
  }
  if (!hex) hex = raw_string(0x00);

  return hex;
}

# Convert a Date CVS field to Unix time 

		</pre> <a href="#top">top</a> <hr> <h2 id="get_mariadb_version">get_mariadb_version</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_mariadb_version(port)
{
  local_var sb;
  sb = string(&quot;mariadb/version/&quot;, port);
  return  get_kb_item(sb);
}

function get_unknown_banner(port, ipproto, dontfetch)

		</pre> <a href="#top">top</a> <hr> <h2 id="get_mysql_version">get_mysql_version</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_mysql_version(port)
{
  local_var sb;
  sb = string(&quot;mysql/version/&quot;, port);
  return  get_kb_item(sb);
}

function set_mariadb_version(port, version)

		</pre> <a href="#top">top</a> <hr> <h2 id="get_port_for_service">get_port_for_service</h2> <h3>Named Parameters</h3> <dl> <dt>default</dt> <dt>ipproto</dt> <dt>proto</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_port_for_service(default, ipproto, proto)
{
  local_var	k, p;
  # Remember: no KB yet in command line mode!
  if (! ipproto) ipproto = &quot;tcp&quot;;
  if (ipproto == &quot;tcp&quot;) k = strcat(&quot;Services/&quot;, proto);
  else k = strcat(&quot;Services/&quot;, ipproto, &quot;/&quot;, proto);
  p = get_kb_item(k);
  if (p) return p;
  k = strcat(&quot;Known/&quot;, ipproto, &quot;/&quot;, default);
  p = get_kb_item(k);
  if (p == proto) return default;
  exit(0);
}

function set_mysql_version(port, version)

		</pre> <a href="#top">top</a> <hr> <h2 id="get_rpc_port">get_rpc_port</h2> <h3>Named Parameters</h3> <dl> <dt>portmap</dt> <dt>program</dt> <dt>protocol</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_rpc_port(program, protocol, portmap)
{ 
 local_var	broken, req, soc, r, port;
 local_var	a, b, c, d, p_a, p_b, p_c, p_d, pt_a, pt_b, pt_c, pt_d;

 
 
 a = rand() % 255;
 b = rand() % 255;
 c = rand() % 255;
 d = rand() % 255;
 
 p_a = program / 16777216; 	p_a = p_a % 256;
 p_b = program / 65356; 	p_b = p_b % 256;
 p_c = program / 256;   	p_c = p_c % 256;
 p_d = program % 256;

 pt_a = protocol / 16777216; pt_a = pt_a % 256;
 pt_b = protocol / 65535   ; pt_b = pt_b % 256;
 pt_c = protocol / 256;    ; pt_c = pt_c % 256;
 pt_d = protocol % 256;
 
 
 req = raw_string(a, 	b, 	c, 	d, 	# XID
 		  0x00, 0x00, 0x00, 0x00,	# Msg type: call
		  0x00, 0x00, 0x00, 0x02,	# RPC Version
		  0x00, 0x01, 0x86, 0xA0,	# Program
		  0x00, 0x00, 0x00, 0x02,	# Program version
		  0x00, 0x00, 0x00, 0x03,	# Procedure
		  0x00, 0x00, 0x00, 0x00,	# Credentials - flavor
		  0x00, 0x00, 0x00, 0x00, 	# Credentials - length
		  0x00, 0x00, 0x00, 0x00,	# Verifier - Flavor
		  0x00, 0x00, 0x00, 0x00,	# Verifier - Length
		  
		  p_a,  p_b,  p_c,  p_d,	# Program
		  0xFF, 0xFF, 0xFF, 0xFF,	# Version (any)
		  pt_a, pt_b, pt_c, pt_d,	# Proto (udp)
		  0x00, 0x00, 0x00, 0x00	# Port
 		  );
	
	  
 if(isnull(portmap)){
   port = int(get_kb_item(&quot;rpc/portmap&quot;));
   if(port == 0)port = 111;
   }
 else port = portmap;
 	  
	  
 broken = get_kb_item(string(&quot;/tmp/rpc/noportmap/&quot;, port));
 if(broken)return(0);
 
 	  
 soc = open_sock_udp(port);
 send(socket:soc, data:req);
 r = recv(socket:soc, length:1024);
 
 close(soc);
 if(!r)
 {
  set_kb_item(name:string(&quot;/tmp/rpc/noportmap/&quot;, port), value:TRUE);
  return(0);
 }
 
 if(strlen(r) &lt; 28)
  return(0);
 else
  {
   p_d = ord(r[27]);
   p_c = ord(r[26]);
   p_b = ord(r[25]);
   p_a = ord(r[24]);
   port = p_a;
   port = port * 256;
   port = port +p_b; 
   port = port * 256;
   port = port + p_c; 
   port = port * 256;
   port = port + p_d;
   return(port);
  }
}

## This function will construct rpc packet

		</pre> <a href="#top">top</a> <hr> <h2 id="get_service_banner_line">get_service_banner_line</h2> <h3>Named Parameters</h3> <dl> <dt>ipproto</dt> <dt>port</dt> <dt>service</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_service_banner_line(service, port, ipproto)
{
  local_var	banner, soc, key, gport, tcp;
  tcp = !ipproto || ipproto == &#39;tcp&#39;;
  if (tcp)
   gport = get_kb_item(strcat(&quot;Services/&quot;, service));
  else
   gport = get_kb_item(strcat(&quot;Services/&quot;, ipproto, &quot;/&quot;, service));
  if(!gport) gport = port;

  if (tcp) 
   key = strcat(service, &quot;/banner/&quot;, gport);
  else
   key = strcat(service, &quot;/banner/&quot;, ipproto, &quot;/&quot;, gport);

  banner = get_kb_item(key);
  
  if(!banner)
  {
    if (! tcp) return;

    if(get_port_state(gport))
    {
      soc = open_sock_tcp(gport);
      if(soc)
      { 
	banner = recv_line(socket:soc, length:2048);
	close(soc);
      }
    }
#   if (banner) set_kb_item(name: key, value: banner);
  }
  
  return(banner);
}
#

		</pre> <a href="#top">top</a> <hr> <h2 id="get_unknown_banner">get_unknown_banner</h2> <h3>Named Parameters</h3> <dl> <dt>dontfetch</dt> <dt>ipproto</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_unknown_banner(port, ipproto, dontfetch)
{
  local_var	sb, sbH, banner, soc, req, tcp, p, bannerHex;

  if (! ipproto) ipproto = &quot;tcp&quot;;
  if ( ipproto == &quot;tcp&quot; )
	tcp = 1;
  else
	tcp = 0;

  if (tcp)
  {
   sb  = strcat(&quot;unknown/banner/&quot;, port);
   sbH = strcat(&quot;unknown/bannerHex/&quot;, port);
  }
  else
  {
   sb  = strcat(&quot;unknown/banner/&quot;, ipproto, &quot;/&quot;, port);
   sbH = strcat(&quot;unknown/bannerHex/&quot;, ipproto, &quot;/&quot;, port);
  }
  banner = get_kb_item(sbH);
  if (banner) return hex2raw(s: banner);
  banner = get_kb_item(banner);
  if (banner) return banner;

  banner = get_kb_item(&quot;BannerHex/&quot;+port);
  if (banner) return(hex2raw(s: banner));
  banner = get_kb_item(&quot;Banner/&quot;+port);
  if (banner) return(banner);
                                                                                
  banner = get_kb_item(&quot;Amap/&quot;+ipproto+&quot;/&quot;+port+&quot;/FullBanner&quot;);
  if (banner) return(banner);

  foreach p (make_list(&quot;spontaneous&quot;, &quot;get_http&quot;, &quot;help&quot;))
  {
    banner = get_kb_item(&quot;FindService/&quot;+ipproto+&quot;/&quot;+port+&quot;/&quot;+p);
    bannerHex = get_kb_item(&quot;FindService/&quot;+ipproto+&quot;/&quot;+port+&quot;/&quot;+p+&quot;Hex&quot;);
    if ( banner &amp;&amp; bannerHex )  
    {
    if (strlen(bannerHex) &gt; 2 * strlen(banner))
     return hex2raw(s: bannerHex);
    else
     return(banner);
    }
  }
  if (dontfetch) return(NULL);
  if (! get_port_state(port)) return (NULL);
  if (! tcp) return (NULL);

  soc = open_sock_tcp(port);
  if(!soc) return (NULL);
  # I don&#39;t think that it makes sense to send an HTTP request
  #req = http_head(item:&quot;/&quot;, port:port);
  #send(socket:soc, data:req);
  banner = recv(socket:soc, length:2048);
  close(soc);
  if (banner)
  {
    replace_kb_item(name: sb, value: banner);
    if (&#39;\0&#39; &gt;&lt; sb)
     replace_kb_item(name: sbH, value: hexstr(banner));
  }
  return(banner);
}

function set_unknown_banner(port, banner, ipproto)

		</pre> <a href="#top">top</a> <hr> <h2 id="get_unknown_svc">get_unknown_svc</h2> <h3>Named Parameters</h3> <dl> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_unknown_svc()
 {

   local_var port;
  
   if(!isnull(_FCT_ANON_ARGS[0])) {
     port = _FCT_ANON_ARGS[0];
   } else {
     port = get_kb_item(&quot;Services/unknown&quot;);
   } 

   if(!port)return 0;
   if (port == 139)return 0;

   if(service_is_unknown(port:port)) {
    return port;
   }  else {
    return 0;
   }  
 }     

function register_service(port, proto, ipproto)

		</pre> <a href="#top">top</a> <hr> <h2 id="hex2raw">hex2raw</h2> <h3>Named Parameters</h3> <dl> <dt>s</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function hex2raw(s)
{
 local_var i, j, ret, l;

 s = chomp(s);	# remove trailing blanks, CR, LF...
 l = strlen(s);
 if (l % 2) {
	display(&quot;hex2raw: odd string: &quot;, s, &quot;\n&quot;);
	l --;
	}
 s = tolower(s);
 for(i=0;i&lt;l;i+=2)
 {
  if(ord(s[i]) &gt;= ord(&quot;0&quot;) &amp;&amp; ord(s[i]) &lt;= ord(&quot;9&quot;))
        j = int(s[i]);
  else
        j = int((ord(s[i]) - ord(&quot;a&quot;)) + 10);

  j *= 16;
  if(ord(s[i+1]) &gt;= ord(&quot;0&quot;) &amp;&amp; ord(s[i+1]) &lt;= ord(&quot;9&quot;))
        j += int(s[i+1]);
  else
        j += int((ord(s[i+1]) - ord(&quot;a&quot;)) + 10);
  ret += raw_string(j);
 }
 return ret;
}

function report_service(port, svc, banner)

		</pre> <a href="#top">top</a> <hr> <h2 id="known_service">known_service</h2> <h3>Named Parameters</h3> <dl> <dt>ipproto</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function known_service(port, ipproto)
{
  local_var	k, p;
  if (! ipproto) ipproto = &quot;tcp&quot;;
  k = strcat(&quot;Known/&quot;, ipproto, &quot;/&quot;, port);
  p = get_kb_item(k);
  #if (p) { display(&quot;Known service on port &quot;, port, &quot;\n&quot;); }
  #else { display(&quot;Unknown service on port &quot;, port, &quot;\n&quot;); }
  return p;
}

# This function does not fork!

		</pre> <a href="#top">top</a> <hr> <h2 id="pow2">pow2</h2> <h3>Named Parameters</h3> <dl> <dt>x</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function pow2(x)
{
 local_var __ret;

 __ret = 1;
 while(x)
  {
  __ret = __ret * 2;
  x = x  - 1;
  }
 return(__ret);
}

function base64(str)

		</pre> <a href="#top">top</a> <hr> <h2 id="rand_str">rand_str</h2> <h3>Named Parameters</h3> <dl> <dt>charset</dt> <dt>length</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function rand_str(length, charset)
{
  local_var	l, i, s, n;

  if (! charset) 
   charset=&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_&quot;;
  if (isnull(length))
    length = 8;
  l = strlen(charset);
  s = &quot;&quot;;
  for (i = 0; i &lt; length; i ++)
  {
    n = rand() % l;
    s += charset[n];
  }
  return s;
}



function add_port_in_list(list, port)

		</pre> <a href="#top">top</a> <hr> <h2 id="register_service">register_service</h2> <h3>Named Parameters</h3> <dl> <dt>ipproto</dt> <dt>port</dt> <dt>proto</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function register_service(port, proto, ipproto)
{
  local_var	k;
  if (! ipproto) ipproto = &quot;tcp&quot;;
  if (! service_is_unknown(port:port, ipproto: ipproto))
  {
    if (debug_level) display(get_host_ip(), &quot;: service is already known on port &quot;, ipproto, &quot;:&quot;, port, &quot;\n&quot;);
    #return(0);
  }
   
  if ( ipproto != &quot;unknown&quot; )
  {
   k = strcat(&quot;Known/&quot;, ipproto, &quot;/&quot;, port);
   replace_kb_item(name: k, value: proto);
   if (ipproto == &quot;tcp&quot;) k = strcat(&quot;Services/&quot;, proto);
   else k = strcat(&quot;Services/&quot;, ipproto, &quot;/&quot;, proto);
   set_kb_item(name: k, value: port);
  }
   if (debug_level) display(get_host_ip(), &quot;: register_service: port=&quot;, port, &quot;, proto=&quot;, proto, &quot;\n&quot;);
}

# This function may fork!

		</pre> <a href="#top">top</a> <hr> <h2 id="report_service">report_service</h2> <h3>Named Parameters</h3> <dl> <dt>banner</dt> <dt>port</dt> <dt>svc</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function report_service(port, svc, banner)
{
 local_var	k, name, a;

 svc = tolower(svc);
 if (! isnull(banner))
 {
  k = strcat(svc, &quot;/banner/&quot;, port);
  set_kb_item(name: k, value: banner);
 }
 register_service(port: port, proto: svc);
 if (svc == &#39;www&#39;) name = &#39;web server&#39;;
 else if (svc == &#39;proxy&#39;) name = &#39;web proxy&#39;;
 else if (svc == &#39;hylafax-ftp&#39; || svc == &#39;hylafax&#39;) name = &#39;HylaFAX server&#39;;
 else if (svc == &#39;agobot.fo&#39;) name = &#39;Agobot.fo backdoor&#39;;
 else if (svc == &#39;unknown_irc_bot&#39;) name = &#39;IRC bot&#39;;
 else if (svc == &#39;auth&#39;) name = &#39;identd&#39;;
 else name = toupper(svc) +&#39; server&#39;;
 a = tolower(name[0]);
 if (a == &#39;a&#39; || a == &#39;e&#39; || a == &#39;i&#39; || a == &#39;o&#39;) a = &#39;An &#39;;
 else a = &#39;A &#39;;
 log_message(port: port, data: a + name + &#39; is running on this port&#39;);
}



function base64_decode(str, key_str)

		</pre> <a href="#top">top</a> <hr> <h2 id="service_is_unknown">service_is_unknown</h2> <h3>Named Parameters</h3> <dl> <dt>ipproto</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function service_is_unknown(port, ipproto)
{
  local_var	k, p;
  if (! ipproto) ipproto = &quot;tcp&quot;;
  k = strcat(&quot;Known/&quot;, ipproto, &quot;/&quot;, port);
  p = get_kb_list(k);
  if (isnull(p)) return TRUE;
  foreach k (p)
    if (k != &quot;unknown&quot;)	# fool proof
      return FALSE;
  return TRUE;
}

function verify_service(port, ipproto, proto)

		</pre> <a href="#top">top</a> <hr> <h2 id="set_mariadb_version">set_mariadb_version</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> <dt>version</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function set_mariadb_version(port, version)
{
  local_var	sb;
  sb = string(&quot;mariadb/version/&quot;, port);
  set_kb_item(name: sb, value: version);
}

function get_mariadb_version(port)

		</pre> <a href="#top">top</a> <hr> <h2 id="set_mysql_version">set_mysql_version</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> <dt>version</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function set_mysql_version(port, version)
{
  local_var	sb;
  sb = string(&quot;mysql/version/&quot;, port);
  set_kb_item(name: sb, value: version);
}

function get_mysql_version(port)

		</pre> <a href="#top">top</a> <hr> <h2 id="set_unknown_banner">set_unknown_banner</h2> <h3>Named Parameters</h3> <dl> <dt>banner</dt> <dt>ipproto</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function set_unknown_banner(port, banner, ipproto)
{
  local_var	sb;
  if (! ipproto || ipproto == &#39;tcp&#39;)
    sb = string(&quot;unknown/banner/&quot;, port);
  else
    sb = strcat(&#39;unknown/banner/&#39;, ipproto, &#39;/&#39;, port);
  set_kb_item(name: sb, value: banner);
  if (&#39;\0&#39; &gt;&lt; banner)
  {
    if (! ipproto || ipproto == &#39;tcp&#39;)
      sb = string(&quot;unknown/bannerHex/&quot;, port);
    else
      sb = strcat(&#39;unknown/bannerHex/&#39;, ipproto, &#39;/&#39;, port);
    set_kb_item(name: sb, value: hexstr(banner));
  }
}

#

		</pre> <a href="#top">top</a> <hr> <h2 id="verify_service">verify_service</h2> <h3>Named Parameters</h3> <dl> <dt>ipproto</dt> <dt>port</dt> <dt>proto</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function verify_service(port, ipproto, proto)
{
  local_var	k, p;
  # Remember: no KB yet in command line mode!
  if (! ipproto) ipproto = &quot;tcp&quot;;
  k = strcat(&quot;Known/&quot;, ipproto, &quot;/&quot;, port);
  p = get_kb_list(k);
  foreach k (p)
    if (k == proto)
      return TRUE;
  return FALSE;
}

# This function may fork

		</pre> <a href="#top">top</a> <hr> </div> </div> <hr> <footer> <p>&copy; Tenable Network Security 2014</p> </footer> </div> <script type="text/javascript" src="js/jquery-1.8.2.js"></script> <script type="text/javascript" src="js/bootstrap.min.js"></script> <script type="text/javascript" src="js/shCore.js"></script> <script type="text/javascript" src="js/shBrushNasl.js"></script> <script type="text/javascript">
    SyntaxHighlighter.defaults['collapse'] = true;
    SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.all();
  </script> </body> </html>