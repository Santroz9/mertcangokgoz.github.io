<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <title>nasldoc: nasl</title> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="description" content=""> <meta name="author" content=""> <style type="text/css">
	body {
	padding-top: 60px;
	padding-bottom: 40px;
	}
	.sidebar-nav {
	padding: 9px 0;
	}
  </style> <link href="css/bootstrap.min.css" rel="stylesheet"> <link href="css/shCore.css" rel="stylesheet" type="text/css"/> <link href="css/shThemeDefault.css" rel="stylesheet" type="text/css"/> <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--> <link rel="shortcut icon" href="ico/favicon.ico"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png"> </head> <body> <div class="navbar navbar-inverse navbar-fixed-top"> <div class="navbar-inner"> <div class="container-fluid"> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="index.html">nasldoc</a> <div class="nav-collapse collapse"> <ul class="nav"> <li class="active"><a href="index.html">Home</a></li> </ul> </div> </div> </div> </div> <div class="container-fluid"> <div class="row-fluid"> <div class="span3"> <div class="well sidebar-nav"> <ul class="nav nav-list"> <li class="even"> <a href="GSHB_BruteForce.html">GSHB_BruteForce.inc</a> </li> <li class="odd"> <a href="GSHB_read_file.html">GSHB_read_file.inc</a> </li> <li class="even"> <a href="bad_ssh_host_keys.html">bad_ssh_host_keys.inc</a> </li> <li class="odd"> <a href="bad_ssh_keys.html">bad_ssh_keys.inc</a> </li> <li class="even"> <a href="bin.html">bin.inc</a> </li> <li class="odd"> <a href="byte_func.html">byte_func.inc</a> </li> <li class="even"> <a href="cisco_ios.html">cisco_ios.inc</a> </li> <li class="odd"> <a href="cpe.html">cpe.inc</a> </li> <li class="even"> <a href="default_account.html">default_account.inc</a> </li> <li class="odd"> <a href="default_credentials.html">default_credentials.inc</a> </li> <li class="even"> <a href="dump.html">dump.inc</a> </li> <li class="odd"> <a href="ftp_func.html">ftp_func.inc</a> </li> <li class="even"> <a href="gb_openssl_heartbeat.html">gb_openssl_heartbeat.inc</a> </li> <li class="odd"> <a href="global_settings.html">global_settings.inc</a> </li> <li class="even"> <a href="gvr_apps_auth_func.html">gvr_apps_auth_func.inc</a> </li> <li class="odd"> <a href="host_details.html">host_details.inc</a> </li> <li class="even"> <a href="hp_printers.html">hp_printers.inc</a> </li> <li class="odd"> <a href="http_func.html">http_func.inc</a> </li> <li class="even"> <a href="http_keepalive.html">http_keepalive.inc</a> </li> <li class="odd"> <a href="imap_func.html">imap_func.inc</a> </li> <li class="even"> <a href="itg.html">itg.inc</a> </li> <li class="odd"> <a href="junos.html">junos.inc</a> </li> <li class="even"> <a href="kyocera_printers.html">kyocera_printers.inc</a> </li> <li class="odd"> <a href="ldap.html">ldap.inc</a> </li> <li class="even"> <a href="lexmark_printers.html">lexmark_printers.inc</a> </li> <li class="odd"> <a href="misc_func.html">misc_func.inc</a> </li> <li class="even"> <a href="netop.html">netop.inc</a> </li> <li class="odd"> <a href="network_func.html">network_func.inc</a> </li> <li class="even"> <a href="nfs_func.html">nfs_func.inc</a> </li> <li class="odd"> <a href="nmap.html">nmap.inc</a> </li> <li class="even"> <a href="nntp_func.html">nntp_func.inc</a> </li> <li class="odd"> <a href="os_eol.html">os_eol.inc</a> </li> <li class="even"> <a href="pingpong.html">pingpong.inc</a> </li> <li class="odd"> <a href="pkg-lib-bsd.html">pkg-lib-bsd.inc</a> </li> <li class="even"> <a href="pkg-lib-deb.html">pkg-lib-deb.inc</a> </li> <li class="odd"> <a href="pkg-lib-gentoo.html">pkg-lib-gentoo.inc</a> </li> <li class="even"> <a href="pkg-lib-hpux.html">pkg-lib-hpux.inc</a> </li> <li class="odd"> <a href="pkg-lib-macosx.html">pkg-lib-macosx.inc</a> </li> <li class="even"> <a href="pkg-lib-rpm.html">pkg-lib-rpm.inc</a> </li> <li class="odd"> <a href="pkg-lib-slack.html">pkg-lib-slack.inc</a> </li> <li class="even"> <a href="pop3_func.html">pop3_func.inc</a> </li> <li class="odd"> <a href="revisions-lib.html">revisions-lib.inc</a> </li> <li class="even"> <a href="rsync_func.html">rsync_func.inc</a> </li> <li class="odd"> <a href="secpod_activex.html">secpod_activex.inc</a> </li> <li class="even"> <a href="secpod_ie_supersede.html">secpod_ie_supersede.inc</a> </li> <li class="odd"> <a href="secpod_reg.html">secpod_reg.inc</a> </li> <li class="even"> <a href="secpod_smb_func.html">secpod_smb_func.inc</a> </li> <li class="odd"> <a href="secpod_ssl_ciphers.html">secpod_ssl_ciphers.inc</a> </li> <li class="even"> <a href="sharp_printers.html">sharp_printers.inc</a> </li> <li class="odd"> <a href="sip.html">sip.inc</a> </li> <li class="even"> <a href="smb_default_credentials.html">smb_default_credentials.inc</a> </li> <li class="odd"> <a href="smb_nt.html">smb_nt.inc</a> </li> <li class="even"> <a href="smbcl_func.html">smbcl_func.inc</a> </li> <li class="odd"> <a href="smtp_func.html">smtp_func.inc</a> </li> <li class="even"> <a href="snmp_func.html">snmp_func.inc</a> </li> <li class="odd"> <a href="solaris.html">solaris.inc</a> </li> <li class="even"> <a href="ssh_func.html">ssh_func.inc</a> </li> <li class="odd"> <a href="ssl_funcs.html">ssl_funcs.inc</a> </li> <li class="even"> <a href="telnet_func.html">telnet_func.inc</a> </li> <li class="odd"> <a href="tftp.html">tftp.inc</a> </li> <li class="even"> <a href="uddi.html">uddi.inc</a> </li> <li class="odd"> <a href="url_func.html">url_func.inc</a> </li> <li class="even"> <a href="version_func.html">version_func.inc</a> </li> <li class="odd"> <a href="vmware_esx.html">vmware_esx.inc</a> </li> <li class="even"> <a href="wmi_file.html">wmi_file.inc</a> </li> <li class="odd"> <a href="wmi_hardware.html">wmi_hardware.inc</a> </li> <li class="even"> <a href="wmi_misc.html">wmi_misc.inc</a> </li> <li class="odd"> <a href="wmi_os.html">wmi_os.inc</a> </li> <li class="even"> <a href="wmi_proc.html">wmi_proc.inc</a> </li> <li class="odd"> <a href="wmi_rsop.html">wmi_rsop.inc</a> </li> <li class="even"> <a href="wmi_svc.html">wmi_svc.inc</a> </li> <li class="odd"> <a href="wmi_user.html">wmi_user.inc</a> </li> <li class="even"> <a href="wordlist.html">wordlist.inc</a> </li> <li class="odd"> <a href="xerox_printers.html">xerox_printers.inc</a> </li> <li class="even"> <a href="xml.html">xml.inc</a> </li> </ul> </div> </div> <div class="span9"> <a name="top"></a> <h1>Overview of smtp_func.inc</h1> <h1>Public Function Summary</h1> <p>Public functions are intended to be called by the code that imports this library.</p> <table class="nopad"> <tr class="TableHeadingColor"> <th>Name</th> <th>Summary</th> </tr> <tr> <td><a href="#get_smtp_banner">get_smtp_banner</a></td> <td></td> </tr> <tr> <td><a href="#smtp_close">smtp_close</a></td> <td></td> </tr> <tr> <td><a href="#smtp_from_header">smtp_from_header</a></td> <td></td> </tr> <tr> <td><a href="#smtp_open">smtp_open</a></td> <td></td> </tr> <tr> <td><a href="#smtp_open_ehlo">smtp_open_ehlo</a></td> <td></td> </tr> <tr> <td><a href="#smtp_recv_banner">smtp_recv_banner</a></td> <td></td> </tr> <tr> <td><a href="#smtp_recv_line">smtp_recv_line</a></td> <td></td> </tr> <tr> <td><a href="#smtp_send_port">smtp_send_port</a></td> <td></td> </tr> <tr> <td><a href="#smtp_send_socket">smtp_send_socket</a></td> <td></td> </tr> <tr> <td><a href="#smtp_to_header">smtp_to_header</a></td> <td></td> </tr> </table> <h1>Public Function Details</h1> <h2 id="get_smtp_banner">get_smtp_banner</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_smtp_banner(port)
{
  local_var sb, banner, soc;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#get_smtp_banner&quot; ); 

  sb = string(&quot;smtp/banner/&quot;, port);
  banner = get_kb_item(sb);
  if(banner) return (banner);
  if ( get_kb_item(&quot;smtp/&quot; + port + &quot;/broken&quot;) ) 
	return NULL;

  if(! get_port_state(port)) return (0);
  soc = open_sock_tcp(port);
  if (! soc) {
	set_kb_item(name:&quot;smtp/&quot; + port + &quot;/broken&quot;, value:TRUE);
        set_kb_item(name: &#39;SMTP/&#39;+port+&#39;/broken&#39;, value: TRUE);
	return NULL;
	}
  banner =  smtp_recv_banner(socket: soc);
  close(soc);
  if(! banner ) {
	set_kb_item(name:&quot;smtp/&quot; + port + &quot;/broken&quot;, value:TRUE);
        set_kb_item(name:&#39;SMTP/&#39;+port+&#39;/broken&#39;, value: TRUE);
	return NULL;
	}
	
  
  replace_kb_item(name: sb, value: banner);
  return(banner);
}


function smtp_recv_line(socket, code, retry, last)

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_close">smtp_close</h2> <h3>Named Parameters</h3> <dl> <dt>socket</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_close(socket)
{
  send(socket: socket, data: &#39;QUIT\r\n&#39;);
  smtp_recv_line(socket: socket);
  close(socket);
}

function smtp_open(port, helo)

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_from_header">smtp_from_header</h2> <h3>Named Parameters</h3> <dl> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_from_header()
{
 local_var fromaddr;
 fromaddr = get_kb_item(&quot;SMTP/headers/From&quot;);
 if (!fromaddr) fromaddr = &quot;openvas@example.com&quot;;
 return (fromaddr);
}

function smtp_to_header()

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_open">smtp_open</h2> <h3>Named Parameters</h3> <dl> <dt>helo</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_open(port, helo)
{
  local_var	soc, data;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#smtp_open&quot; );

  soc = open_sock_tcp(port);
  if (! soc) return NULL;

  data = smtp_recv_banner(socket:soc);
  if (! data)
  {
    smtp_close(socket: soc);
    return NULL;
  }
  
  if ( isnull(helo) ) return soc;

  send(socket:soc, data: strcat(&#39;HELO &#39;, helo, &#39;\r\n&#39;));
  data = smtp_recv_line(socket: soc);
  if(! ereg(pattern:&quot;^[2-3][0-9][0-9]&quot;, string:data))
  {
    smtp_close(socket: soc);
    return NULL;
  }

  return soc;  
}

function smtp_open_ehlo(port, helo)

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_open_ehlo">smtp_open_ehlo</h2> <h3>Named Parameters</h3> <dl> <dt>helo</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_open_ehlo(port, helo)
{
  local_var     soc, data;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#smtp_open_ehlo&quot; );

  soc = open_sock_tcp(port);
  if (! soc) return NULL;

  data = smtp_recv_banner(socket:soc);
  if (! data)
  {
    smtp_close(socket: soc);
    return NULL;
  }

  if ( isnull(helo) ) return soc;

  send(socket:soc, data: strcat(&#39;EHLO &#39;, helo, &#39;\r\n&#39;));
  data = smtp_recv_line(socket: soc);
  if(! ereg(pattern:&quot;^[2-3][0-9][0-9]&quot;, string:data))
  {
    smtp_close(socket: soc);
    return NULL;
  }

  return soc;
}

function smtp_send_socket(socket, from, to, body)

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_recv_banner">smtp_recv_banner</h2> <h3>Named Parameters</h3> <dl> <dt>socket</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_recv_banner(socket)
{
  return smtp_recv_line(socket: socket, code: &quot;220&quot;);
}


		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_recv_line">smtp_recv_line</h2> <h3>Named Parameters</h3> <dl> <dt>code</dt> <dt>last</dt> <dt>retry</dt> <dt>socket</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_recv_line(socket, code, retry, last)
{
 local_var ret, n, r, pat;
 
 if (isnull(code))
   pat = &quot;^[0-9][0-9][0-9]-&quot;;
 else
   pat = strcat(&quot;^&quot;, code, &quot;-&quot;);

 ret = &quot;&quot;;
 r = recv_line(socket:socket, length:4096);
 #
 n = 0;
 while (! r &amp;&amp; n ++ &lt; retry)
   r = recv_line(socket:socket, length:4096);
 #
 n = 0;
 ret = r;
 if(strlen(r) &lt; 4) 
  return r;
  
 while(ereg(pattern: pat, string:r))
 {
  n = n + 1;
  r = recv_line(socket:socket, length:4096);
  if (strlen(r) == 0) break;
  if (n &gt; 512)
   return NULL;
  if (last) ret = r;
  else      ret = strcat(ret, r);
 }
 return ret;
}

function smtp_recv_banner(socket)

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_send_port">smtp_send_port</h2> <h3>Named Parameters</h3> <dl> <dt>body</dt> <dt>from</dt> <dt>port</dt> <dt>to</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_send_port(port, from, to, body)
{
  local_var s, buff, ret, hostname;
  s = open_sock_tcp(port);
  if (! s) return (0);

  buff = recv_line(socket: s, length: 2048);
  hostname = get_kb_item(&#39;smtp/&#39;+&#39;/helo&#39;);
  if (! hostname) hostname = &#39;openvas&#39;;
  send(socket: s, data: strcat(&#39;HELO &#39;, hostname, &#39;\r\n&#39;));
  buff = recv_line(socket: s, length: 2048);
  # We should test the code
  ret = smtp_send_socket(socket: s, from: from, to: to, body: body);
  send(socket: s, data: string(&quot;QUIT\r\n&quot;));
  close(s);
  return (ret);
}

function smtp_from_header()

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_send_socket">smtp_send_socket</h2> <h3>Named Parameters</h3> <dl> <dt>body</dt> <dt>from</dt> <dt>socket</dt> <dt>to</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_send_socket(socket, from, to, body)
{
  local_var buff;
  # display(string(&quot;smtp_send_socket from=&quot;, from, &quot; to=&quot;, to, &quot;\n&quot;));
  # Just to be sure
  send(socket: socket, data: string(&quot;RSET\r\n&quot;));
  buff = recv_line(socket: socket, length: 2048);
  # Here, we might test the return code
  if (from !~ &#39; *&lt;.*&gt; *&#39;) from = strcat(&#39;&lt;&#39;, from, &#39;&gt;&#39;);
  send(socket: socket, data: string(&quot;MAIL FROM: &quot;, from, &quot;\r\n&quot;));
  buff = recv_line(socket: socket, length: 2048);
  if (! ereg(pattern:&quot;^2[0-9][0-9] &quot;, string:buff)) { return (0); }
  
  if (to !~ &#39; *&lt;.*&gt; *&#39;) to = strcat(&#39;&lt;&#39;, to, &#39;&gt;&#39;);
  send(socket: socket, data: string(&quot;RCPT TO: &quot;, to, &quot;\r\n&quot;));
  buff = recv_line(socket: socket, length: 2048);
  if (! ereg(pattern:&quot;^2[0-9][0-9] &quot;, string:buff)) { return (0); }

  send(socket: socket, data: string(&quot;DATA\r\n&quot;));
  buff = recv_line(socket: socket, length: 2048);
  if (! ereg(pattern:&quot;^3[0-9][0-9] &quot;, string:buff)) { return (0); }

  # Make sure that every line ends up with \r\n
  # This is not useful yet, as only two scripts send data to the SMTP server
  #body = ereg_replace(string: body, pattern: string(&quot;([^\r])\n&quot;), replace: string(&quot;\\1\r\n&quot;));
  send(socket: socket, data: body);
  send(socket: socket, data: string(&quot;\r\n.\r\n&quot;));
  buff = recv_line(socket: socket, length: 2048);
  if (! ereg(pattern:&quot;^2[0-9][0-9] &quot;, string:buff)) { return (0); }
  return(1);
}

function smtp_send_port(port, from, to, body)

		</pre> <a href="#top">top</a> <hr> <h2 id="smtp_to_header">smtp_to_header</h2> <h3>Named Parameters</h3> <dl> </dl> <h3>Code</h3> <pre class="brush: nasl">
function smtp_to_header()
{
 local_var toaddr;
 toaddr = get_kb_item(&quot;SMTP/headers/To&quot;);
 if (!toaddr) toaddr = string(&quot;postmaster@[&quot;, get_host_ip(), &quot;]&quot;);
 return (toaddr);
}

function get_smtp_banner(port)

		</pre> <a href="#top">top</a> <hr> </div> </div> <hr> <footer> <p>&copy; Tenable Network Security 2014</p> </footer> </div> <script type="text/javascript" src="js/jquery-1.8.2.js"></script> <script type="text/javascript" src="js/bootstrap.min.js"></script> <script type="text/javascript" src="js/shCore.js"></script> <script type="text/javascript" src="js/shBrushNasl.js"></script> <script type="text/javascript">
    SyntaxHighlighter.defaults['collapse'] = true;
    SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.all();
  </script> </body> </html>