<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <title>nasldoc: nasl</title> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="description" content=""> <meta name="author" content=""> <style type="text/css">
	body {
	padding-top: 60px;
	padding-bottom: 40px;
	}
	.sidebar-nav {
	padding: 9px 0;
	}
  </style> <link href="css/bootstrap.min.css" rel="stylesheet"> <link href="css/shCore.css" rel="stylesheet" type="text/css"/> <link href="css/shThemeDefault.css" rel="stylesheet" type="text/css"/> <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]--> <link rel="shortcut icon" href="ico/favicon.ico"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png"> <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png"> </head> <body> <div class="navbar navbar-inverse navbar-fixed-top"> <div class="navbar-inner"> <div class="container-fluid"> <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </a> <a class="brand" href="index.html">nasldoc</a> <div class="nav-collapse collapse"> <ul class="nav"> <li class="active"><a href="index.html">Home</a></li> </ul> </div> </div> </div> </div> <div class="container-fluid"> <div class="row-fluid"> <div class="span3"> <div class="well sidebar-nav"> <ul class="nav nav-list"> <li class="even"> <a href="GSHB_BruteForce.html">GSHB_BruteForce.inc</a> </li> <li class="odd"> <a href="GSHB_read_file.html">GSHB_read_file.inc</a> </li> <li class="even"> <a href="bad_ssh_host_keys.html">bad_ssh_host_keys.inc</a> </li> <li class="odd"> <a href="bad_ssh_keys.html">bad_ssh_keys.inc</a> </li> <li class="even"> <a href="bin.html">bin.inc</a> </li> <li class="odd"> <a href="byte_func.html">byte_func.inc</a> </li> <li class="even"> <a href="cisco_ios.html">cisco_ios.inc</a> </li> <li class="odd"> <a href="cpe.html">cpe.inc</a> </li> <li class="even"> <a href="default_account.html">default_account.inc</a> </li> <li class="odd"> <a href="default_credentials.html">default_credentials.inc</a> </li> <li class="even"> <a href="dump.html">dump.inc</a> </li> <li class="odd"> <a href="ftp_func.html">ftp_func.inc</a> </li> <li class="even"> <a href="gb_openssl_heartbeat.html">gb_openssl_heartbeat.inc</a> </li> <li class="odd"> <a href="global_settings.html">global_settings.inc</a> </li> <li class="even"> <a href="gvr_apps_auth_func.html">gvr_apps_auth_func.inc</a> </li> <li class="odd"> <a href="host_details.html">host_details.inc</a> </li> <li class="even"> <a href="hp_printers.html">hp_printers.inc</a> </li> <li class="odd"> <a href="http_func.html">http_func.inc</a> </li> <li class="even"> <a href="http_keepalive.html">http_keepalive.inc</a> </li> <li class="odd"> <a href="imap_func.html">imap_func.inc</a> </li> <li class="even"> <a href="itg.html">itg.inc</a> </li> <li class="odd"> <a href="junos.html">junos.inc</a> </li> <li class="even"> <a href="kyocera_printers.html">kyocera_printers.inc</a> </li> <li class="odd"> <a href="ldap.html">ldap.inc</a> </li> <li class="even"> <a href="lexmark_printers.html">lexmark_printers.inc</a> </li> <li class="odd"> <a href="misc_func.html">misc_func.inc</a> </li> <li class="even"> <a href="netop.html">netop.inc</a> </li> <li class="odd"> <a href="network_func.html">network_func.inc</a> </li> <li class="even"> <a href="nfs_func.html">nfs_func.inc</a> </li> <li class="odd"> <a href="nmap.html">nmap.inc</a> </li> <li class="even"> <a href="nntp_func.html">nntp_func.inc</a> </li> <li class="odd"> <a href="os_eol.html">os_eol.inc</a> </li> <li class="even"> <a href="pingpong.html">pingpong.inc</a> </li> <li class="odd"> <a href="pkg-lib-bsd.html">pkg-lib-bsd.inc</a> </li> <li class="even"> <a href="pkg-lib-deb.html">pkg-lib-deb.inc</a> </li> <li class="odd"> <a href="pkg-lib-gentoo.html">pkg-lib-gentoo.inc</a> </li> <li class="even"> <a href="pkg-lib-hpux.html">pkg-lib-hpux.inc</a> </li> <li class="odd"> <a href="pkg-lib-macosx.html">pkg-lib-macosx.inc</a> </li> <li class="even"> <a href="pkg-lib-rpm.html">pkg-lib-rpm.inc</a> </li> <li class="odd"> <a href="pkg-lib-slack.html">pkg-lib-slack.inc</a> </li> <li class="even"> <a href="pop3_func.html">pop3_func.inc</a> </li> <li class="odd"> <a href="revisions-lib.html">revisions-lib.inc</a> </li> <li class="even"> <a href="rsync_func.html">rsync_func.inc</a> </li> <li class="odd"> <a href="secpod_activex.html">secpod_activex.inc</a> </li> <li class="even"> <a href="secpod_ie_supersede.html">secpod_ie_supersede.inc</a> </li> <li class="odd"> <a href="secpod_reg.html">secpod_reg.inc</a> </li> <li class="even"> <a href="secpod_smb_func.html">secpod_smb_func.inc</a> </li> <li class="odd"> <a href="secpod_ssl_ciphers.html">secpod_ssl_ciphers.inc</a> </li> <li class="even"> <a href="sharp_printers.html">sharp_printers.inc</a> </li> <li class="odd"> <a href="sip.html">sip.inc</a> </li> <li class="even"> <a href="smb_default_credentials.html">smb_default_credentials.inc</a> </li> <li class="odd"> <a href="smb_nt.html">smb_nt.inc</a> </li> <li class="even"> <a href="smbcl_func.html">smbcl_func.inc</a> </li> <li class="odd"> <a href="smtp_func.html">smtp_func.inc</a> </li> <li class="even"> <a href="snmp_func.html">snmp_func.inc</a> </li> <li class="odd"> <a href="solaris.html">solaris.inc</a> </li> <li class="even"> <a href="ssh_func.html">ssh_func.inc</a> </li> <li class="odd"> <a href="ssl_funcs.html">ssl_funcs.inc</a> </li> <li class="even"> <a href="telnet_func.html">telnet_func.inc</a> </li> <li class="odd"> <a href="tftp.html">tftp.inc</a> </li> <li class="even"> <a href="uddi.html">uddi.inc</a> </li> <li class="odd"> <a href="url_func.html">url_func.inc</a> </li> <li class="even"> <a href="version_func.html">version_func.inc</a> </li> <li class="odd"> <a href="vmware_esx.html">vmware_esx.inc</a> </li> <li class="even"> <a href="wmi_file.html">wmi_file.inc</a> </li> <li class="odd"> <a href="wmi_hardware.html">wmi_hardware.inc</a> </li> <li class="even"> <a href="wmi_misc.html">wmi_misc.inc</a> </li> <li class="odd"> <a href="wmi_os.html">wmi_os.inc</a> </li> <li class="even"> <a href="wmi_proc.html">wmi_proc.inc</a> </li> <li class="odd"> <a href="wmi_rsop.html">wmi_rsop.inc</a> </li> <li class="even"> <a href="wmi_svc.html">wmi_svc.inc</a> </li> <li class="odd"> <a href="wmi_user.html">wmi_user.inc</a> </li> <li class="even"> <a href="wordlist.html">wordlist.inc</a> </li> <li class="odd"> <a href="xerox_printers.html">xerox_printers.inc</a> </li> <li class="even"> <a href="xml.html">xml.inc</a> </li> </ul> </div> </div> <div class="span9"> <a name="top"></a> <h1>Overview of http_func.inc</h1> <h1>Public Variable Summary</h1> <p>Public variables are intended to be accessed by the code that imports this library.</p> <table class="nopad"> <tr class="TableHeadingColor"> <th>Name</th> <th>Summary</th> </tr> <tr> <td><a href="#OPENVAS_HTTP_USER_AGENT">OPENVAS_HTTP_USER_AGENT</a></td> <td></td> </tr> </table> <h1>Public Function Summary</h1> <p>Public functions are intended to be called by the code that imports this library.</p> <table class="nopad"> <tr class="TableHeadingColor"> <th>Name</th> <th>Summary</th> </tr> <tr> <td><a href="#can_host_asp">can_host_asp</a></td> <td></td> </tr> <tr> <td><a href="#can_host_php">can_host_php</a></td> <td></td> </tr> <tr> <td><a href="#cgi_dirs">cgi_dirs</a></td> <td></td> </tr> <tr> <td><a href="#check_win_dir_trav">check_win_dir_trav</a></td> <td></td> </tr> <tr> <td><a href="#do_check_win_dir_trav">do_check_win_dir_trav</a></td> <td></td> </tr> <tr> <td><a href="#get_http_banner">get_http_banner</a></td> <td></td> </tr> <tr> <td><a href="#get_http_port">get_http_port</a></td> <td></td> </tr> <tr> <td><a href="#headers_split">headers_split</a></td> <td></td> </tr> <tr> <td><a href="#hex2dec">hex2dec</a></td> <td></td> </tr> <tr> <td><a href="#http_40x">http_40x</a></td> <td></td> </tr> <tr> <td><a href="#http_gunzip">http_gunzip</a></td> <td></td> </tr> <tr> <td><a href="#http_host_name">http_host_name</a></td> <td></td> </tr> <tr> <td><a href="#http_is_dead">http_is_dead</a></td> <td></td> </tr> <tr> <td><a href="#http_recv">http_recv</a></td> <td></td> </tr> <tr> <td><a href="#http_recv_body">http_recv_body</a></td> <td></td> </tr> <tr> <td><a href="#http_recv_headers2">http_recv_headers2</a></td> <td></td> </tr> <tr> <td><a href="#http_recv_length">http_recv_length</a></td> <td></td> </tr> <tr> <td><a href="#http_send_recv">http_send_recv</a></td> <td></td> </tr> <tr> <td><a href="#make_list_unique">make_list_unique</a></td> <td></td> </tr> <tr> <td><a href="#php_ver_match">php_ver_match</a></td> <td></td> </tr> </table> <h1>Private Function Summary</h1> <p>Private functions are not intended to be called by the code that imports this library. There is no functional difference between private and public functions, only convention, and they may be called as normal. </p> <table class="nopad"> <tr class="TableHeadingColor"> <th>Name</th> <th>Summary</th> </tr> <tr> <td><a href="#__hex_value">__hex_value</a></td> <td></td> </tr> </table> <h1>Public Variable Details</h1> <h2 id="OPENVAS_HTTP_USER_AGENT">OPENVAS_HTTP_USER_AGENT</h2> <a href="#top">top</a> <hr> <h1>Public Function Details</h1> <h2 id="can_host_asp">can_host_asp</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function can_host_asp( port ) {

  local_var banner, sig, files;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#can_host_asp&quot; );

  banner = get_http_banner( port:port );
  if( ! banner ) {
    return 0;
  } else {
    if( egrep( pattern:&quot;^Server:.*IIS&quot;, string:banner, icase:TRUE ) ) {
      #display( get_host_ip(), &quot; may host ASP\n&quot; );
      return 1;
    }
  }

  if( tolower( banner ) =~ &#39;powered.*asp&#39; || tolower( banner ) =~  &quot;server.*asp.*&quot; ) return TRUE;

  #TBD: Move before the banner check?
  files = get_kb_list( &quot;www/&quot; + port + &quot;/content/extensions/asp&quot; );
  if( ! isnull( files ) ) {
    #display( get_host_ip(), &quot; hosts ASP - &quot;, files[0], &quot;\n&quot; );
    return 1; # Hosting .asp files
  }

  sig = banner;
  if( ! sig ) { #TBD: This looks wrong...
    #display( get_host_ip(), &quot; has no sig\n&quot; ); 
    # Could not fingerprint it, even though we know that IIS fingerprint
    # is quite reliable 
    if( egrep( pattern:&quot;^Server:.*&quot;, string:banner, icase:TRUE ) ) {
      return 0;
    } else {
      return 1; # Unknown web server - might be able to host a ASP website
    }
  }

  if( egrep( pattern:&quot;iis&quot;, string:sig, icase:TRUE ) ) {
    #display( get_host_ip(), &quot; may be ASP site (sig)\n&quot; );
    return 1;
  } else {
    #display( get_host_ip(), &quot; is definitely NOT a ASP site (sig) - &quot;, sig, &quot;\n&quot; );
    return 0;
  }
}

function http_40x( port, code ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="can_host_php">can_host_php</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function can_host_php( port ) {

  local_var banner, sig, files;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#can_host_php&quot; );

  if( get_kb_item( &quot;www/&quot;+port+&quot;/PHP&quot; ) ) return TRUE;

  banner = get_http_banner( port:port );

  if( ! banner ) {
    return 0;
  } else {

    if( tolower( banner ) =~ &#39;powered.*php&#39; || tolower( banner ) =~ &quot;server.*php.*&quot; ) return TRUE; 

    if( egrep( pattern:&quot;^Server:.*IceWarp&quot;, string:banner, icase:TRUE ) ) {
      return 1;
    }

    if( egrep( pattern:&quot;^Server:.*apache|nginx|thttpd|aolserver|pi3web|zeus|iis&quot;, string:banner, icase:TRUE ) ) {
      #display( get_host_ip(), &quot; may host PHP\n&quot; );
      return 1;
    }
  }

  #TBD: Move before the banner check?
  files = get_kb_list( &quot;www/&quot; + port + &quot;/content/extensions/php*&quot; );
  if( ! isnull( files ) ) {
    #display( get_host_ip(), &quot; hosts PHP - &quot;, files[0], &quot;\n&quot; );
    return 1; # Hosting .php+ files
  }

  sig = banner;
  if( ! sig ) { 
    return 1; # Unknown web server - might be able to host a PHP website
  }

  if( egrep( pattern:&quot;apache|thttpd|aolserver|pi3web|zeus|iis&quot;, string:sig, icase:TRUE ) ) {
    #display( get_host_ip(), &quot; may be PHP site (sig)\n&quot; );
    return 1;
  } else {
    #display( get_host_ip(), &quot; is definitely NOT a PHP site (sig) - &quot;, sig, &quot;\n&quot; );
    return 0;
  }
}

function can_host_asp( port ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="cgi_dirs">cgi_dirs</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function cgi_dirs( port ) {

  local_var kb;

  if( get_kb_item( &quot;Settings/disable_cgi_scanning&quot; ) ) return NULL;

  if( port ) {
    kb = get_kb_list( &quot;www/&quot; + port + &quot;/content/directories&quot; );
  } else {
    kb = get_kb_list( &quot;www/*/content/directories&quot; );
  }

  usercgis = get_kb_list( &quot;/user/cgis&quot; );
  if( isnull( usercgis ) ) usercgis = &quot;/&quot;;
  if( isnull( kb ) ) {
    kb = make_list( usercgis, &quot;/cgi-bin&quot;, &quot;/scripts&quot;, &quot;/&quot; );
  } else {
    kb = make_list( usercgis, kb, &quot;/&quot; );
  }

  return( make_list_unique( kb ) );
}

function can_host_php( port ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="check_win_dir_trav">check_win_dir_trav</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> <dt>quickcheck</dt> <dt>url</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function check_win_dir_trav( port, url, quickcheck ) {
  if( do_check_win_dir_trav( port:port, url:url + rand(), quickcheck:quickcheck ) )
    return NULL;
  else
    return do_check_win_dir_trav( port:port, url:url, quickcheck:quickcheck );
}

function http_recv_headers2( socket ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="do_check_win_dir_trav">do_check_win_dir_trav</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> <dt>quickcheck</dt> <dt>url</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function do_check_win_dir_trav( port, url, quickcheck ) {

  local_var soc, req, cod, buf;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#do_check_win_dir_trav&quot; );
  if( ! url ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#url#-#do_check_win_dir_trav&quot; );

  #display(&quot;check_win_dir_trav(port=&quot;, port, &quot;, url=&quot;, url, &quot;, quickcheck=&quot;, quickcheck, &quot;)\n&quot;);
  soc = http_open_socket( port );
  if( ! soc ) {
    # display(&quot;check_win_dir_trav: cannot open socket to &quot;, port, &quot;\n&quot;);
    return( 0 );
  }

  req = http_get( item:url, port:port );
  send( socket:soc, data:req );
  cod = recv_line( socket:soc, length:80 );
  buf = http_recv( socket:soc, code:cod );

  if( &quot;content-encoding: gzip&quot; &gt;&lt; tolower( buf ) )
    buf = http_gunzip( buf:buf );

  http_close_socket( soc );

  if( quickcheck ) {
    if( &quot; 200 &quot; &gt;&lt; cod ) return( 1 );
    return( 0 );
  }

  if( &quot;; for 16-bit app support&quot; &gt;&lt; buf || &quot;[boot loader]&quot; &gt;&lt; buf ) {
    return( 1 );
  }
  return( 0 );
}

function check_win_dir_trav( port, url, quickcheck ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="get_http_banner">get_http_banner</h2> <h3>Named Parameters</h3> <dl> <dt>file</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_http_banner( port, file ) {

  local_var soc, sb, banner, req, body;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#get_http_banner&quot; );

  if( ! file ) file = &quot;/&quot;;

  if( get_kb_item( &quot;Services/www/&quot; + port + &quot;/broken&quot; ) ) return NULL;

  if( ! get_port_state( port ) ) return (0);

  sb = strcat( &quot;www/real_banner/&quot;, port, file );
  banner = get_kb_item( sb );
  if( banner ) return( banner );

  sb = strcat( &quot;www/banner/&quot;, port, file );
  banner = get_kb_item( sb );
  if( banner ) return( banner );

  soc = http_open_socket( port );
  if( ! soc ) return( NULL );
  req = http_get( item:file, port:port );
  send( socket:soc, data:req );
  banner = http_recv_headers2( socket:soc );
  #body = http_recv_body( socket:soc, headers:banner );
  http_close_socket( soc );
  if( banner ) replace_kb_item( name:sb, value:banner );
  return( banner );
}

# Submitted by Georges Dagousset

		</pre> <a href="#top">top</a> <hr> <h2 id="get_http_port">get_http_port</h2> <h3>Named Parameters</h3> <dl> <dt>default</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function get_http_port( default ) {

  local_var default, port, p;

  if( ! default ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#default#-#get_http_port&quot; );

  port = get_kb_item( &quot;Services/www&quot; );
  if( port ) default = port;

  p = get_kb_item( &quot;Services/www/&quot; + default + &quot;/broken&quot; );
  if( p ) exit( 0 );

  p = get_kb_item( &quot;Services/www/&quot; + default + &quot;/working&quot; );
  if( p ) return default;

  if( ! get_port_state( default ) ) exit( 0 );

  return default;
}

# (C) Georges Dagousset

		</pre> <a href="#top">top</a> <hr> <h2 id="headers_split">headers_split</h2> <h3>Named Parameters</h3> <dl> <dt>h</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function headers_split( h ) {

  local_var ret, array, item, subarray, end;

  if( ! h ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#h#-#headers_split&quot; );

  end = strstr( h, &#39;\r\n\r\n&#39; );
  if( end ) h -= end;

  array = split( h, keep:FALSE );
  foreach item( array ) {
    subarray = split( item, sep:&#39;:&#39;, keep:FALSE );
    ret[tolower( subarray[0] )] = ereg_replace( pattern:&quot;^ *&quot;, replace:&quot;&quot;, string:subarray[1] );
  }
  return ret;
}

#

		</pre> <a href="#top">top</a> <hr> <h2 id="hex2dec">hex2dec</h2> <h3>Named Parameters</h3> <dl> <dt>xvalue</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function hex2dec( xvalue ) {

  local_var ret, l, i, n, m;

  if( ! xvalue ) {
    set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#xvalue#-#hex2dec&quot; );
    return(0);
  }

  xvalue = tolower( xvalue );
  if( &#39;\r\n&#39; &gt;&lt; xvalue ) {
    l = strlen( xvalue ) - 2;
  } else if( &#39;\n&#39; &gt;&lt; xvalue ) {
    l = strlen( xvalue ) - 1;
  } else {
    l = strlen( xvalue );
  }

  ret = 0;
  m = 1;
  if( l == 0 ) return 0;

  # Remove the trailing spaces
  while( xvalue[l - 1] == &quot; &quot; &amp;&amp; l &gt; 0 ) l--;

  for( i = l; i &gt; 0; i-- ) {
    n = __hex_value( num:xvalue[i - 1] ) * m;
    ret = ret + n;
    m = m * 16;
  }
  return int( ret );
}

function get_http_banner( port, file ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="http_40x">http_40x</h2> <h3>Named Parameters</h3> <dl> <dt>code</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_40x( port, code ) {

  local_var no404;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#http_40x&quot; );
  if( ! code ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#code#-#http_40x&quot; );

  if( ereg( string:code, pattern:&quot;^HTTP/1\.[01] +40[0-9]&quot; ) )
    return TRUE;

  no404 = get_kb_item( &quot;www/no404/&quot; + port );
  if( no404 &amp;&amp; no404 &gt;&lt; code )
    return TRUE;
  return FALSE;
}

function http_gunzip( buf, onlybody ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="http_gunzip">http_gunzip</h2> <h3>Named Parameters</h3> <dl> <dt>buf</dt> <dt>onlybody</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_gunzip( buf, onlybody ) {

  local_var onlybody, lines, line, sep, header, body, h, tmpdir, tmpfile, tmpfile_gz, res;

  if( ! buf ) {
    set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#buf#-#http_gunzip&quot; );
    return FALSE;
  }

  if( &quot;##**##UNZIPPED##**##&quot; &gt;&lt; buf ) return buf; 

  if( &quot;content-encoding: gzip&quot; &gt;!&lt; tolower( buf ) &amp;&amp; ! onlybody ) return buf;

  if( ! onlybody ) {

    lines = split( buf, keep:FALSE );

    foreach line( lines ) {

      if( ! sep &amp;&amp; line !~ &quot;^$&quot; )
        header += line + &#39;\n&#39;;

      if( line =~ &quot;^$&quot; &amp;&amp; ! body ) {
        sep = TRUE;
        continue;
      }

      if( sep )
        body += line + &#39;\n&#39;;
    }
  } else {
    body = buf;
  }

  if( ! body ) return buf;

  if( defined_func( &quot;gunzip&quot; ) ) {

    if( body = gunzip( data:body ) ) {

      if( onlybody ) return body + &#39;\n\n\n##**##UNZIPPED##**##&#39;;

      h = ereg_replace( string:header, pattern:&#39;(content-encoding:[^\r\n]+[\r\n]+)&#39;, replace:&quot;&quot;, icase:TRUE );
      return( h + &#39;\r\n\r\n&#39; + body + &#39;\n\n\n##**##UNZIPPED##**##&#39; );
    } 
    return buf;
  } else {

    if( ! find_in_path( &quot;gunzip&quot; ) ) return buf;

    tmpdir = get_tmp_dir();
    if( ! tmpdir ) return buf;

    file = &quot;openvas_&quot; + rand();
    tmpfile = tmpdir + file;
    tmpfile_gz = tmpfile + &#39;.gz&#39;;

    if( ! fwrite( data:body + &#39;\r\n&#39;, file:tmpfile_gz ) ) return buf;

    argv[i++] =&quot;gunzip&quot;;
    argv[i++] = tmpfile_gz;

    res = pread( cmd:&quot;gunzip&quot;, argv:argv, cd:0 );

    if( file_stat( tmpfile_gz ) ) unlink( tmpfile_gz );

    if( file_stat( tmpfile ) ) {

      res = fread( tmpfile );
      unlink( tmpfile );

      if( ! res ) return buf;

      if( onlybody ) return res + &#39;\n\n\n##**##UNZIPPED##**##&#39;;

      h = ereg_replace( string:header, pattern:&#39;(content-encoding:[^\r\n]+[\r\n]+)&#39;, replace:&quot;&quot;, icase:TRUE );
      return h + &#39;\r\n\r\n&#39; + res  + &#39;\n\n\n##**##UNZIPPED##**##&#39;;
    }
  }   
  return buf;
}

function http_host_name( port ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="http_host_name">http_host_name</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_host_name( port ) {

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#http_host_name&quot; );

  host = get_host_name();
  if( port ) {
    if( port != 80 &amp;&amp; port != 443 )
      host += &#39;:&#39; + port;
  }
  return host;
}

function make_list_unique( ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="http_is_dead">http_is_dead</h2> <h3>Named Parameters</h3> <dl> <dt>port</dt> <dt>retry</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_is_dead( port, retry ) {

  local_var soc, url, req, code, h, h2, b, i;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#http_is_dead&quot; );

  if( ! retry ) retry = 2;

  i = 0;
  soc = http_open_socket( port );
  while( ! soc &amp;&amp; i++ &lt; retry ) {
    sleep( 1 ); # Should we use sleep(i) ?
    soc = http_open_socket( port );
    #display(&quot;i = &quot;, i, &quot;\n&quot;);
  }
  if( ! soc ) return( 1 );
  # NB: http_head does not work against SWAT &amp; VNC (&amp; probably others...)
  url = strcat( &quot;/OpenVASTest&quot;, rand(), &quot;.html&quot; );
  req = http_get( item:url, port:port );

  send( socket:soc, data:req );
  code = recv_line( socket:soc, length:1024 );
  if( code ) {
    h = http_recv_headers2( socket:soc );
    h2 = strcat( code, h );
    b = http_recv_body( socket:soc, headers:h2 );
  }
  http_close_socket( soc );
  if( ! code ) return( 1 );
  # 500: internal server error
  # 501: not implemented = unsupported method...
  # 502: Bad gateway = upstream server sends an invalid response
  # 503: service unavailable = temporary overloading...
  # 504: gateway timeout = no timely response from upstream server
  if( ereg( pattern:&quot;^HTTP/1\.[01] +50[234]&quot;, string:code ) ) return( 1 );
  return( 0 );
}

# This function was originally written by SecurITeam in 

		</pre> <a href="#top">top</a> <hr> <h2 id="http_recv">http_recv</h2> <h3>Named Parameters</h3> <dl> <dt>code</dt> <dt>socket</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_recv( socket, code ) {

  local_var h, b, l;

  if( ! socket ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#socket#-#http_recv&quot; );

  if( code ) {
    h = strcat( code ); # Convert to string, just in case
    repeat
    {
      l = recv_line( socket:socket, length:2048 );
      h = h + l;
    }
    until( ! l || l =~ &#39;^[\r\n]+$&#39; ); # EOF or empty line
    if( ! l ) return h;
  } else {
    h = http_recv_headers2( socket:socket );
    if( ! h ) return( NULL );
    else if( ! ereg( pattern:&quot;^HTTP/.* [0-9]*&quot;, string:h ) ) return h;
    h = strcat( h, &#39;\r\n&#39; );
  }
  b = http_recv_body( socket:socket, headers:h, length:0 );
  return strcat( h, b );
}

function http_recv_length( socket, bodylength ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="http_recv_body">http_recv_body</h2> <h3>Named Parameters</h3> <dl> <dt>headers</dt> <dt>length</dt> <dt>socket</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_recv_body( socket, headers, length ) {

  local_var h, cl, l, min, max, x, n, to, gzip;

  if( ! socket ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#socket#-#http_recv_body&quot; );

  if( ! headers ) {
    h = http_recv_headers2( socket:socket );
  } else {
    h = headers;
  }

  l = -1;
  cl = egrep( pattern:&quot;^Content-length: *[0-9]+&quot;, string:h, icase:TRUE );
  if( &quot;content-encoding: gzip&quot; &gt;&lt; tolower( h ) ) gzip = TRUE;

  if( cl ) {
    l = int( ereg_replace( pattern:&quot;Content-length: *([0-9]+).*&quot;, replace:&quot;\1&quot;, string:cl, icase:TRUE ) );
  }
  # &quot;l&quot; = Content-Length or -1 now

  max = -1;
  min = -1;

  if( l &lt; 0 &amp;&amp; egrep( pattern:&quot;^transfer-encoding: chunked&quot;, string:h, icase:TRUE ) ) {

    local_var tmp, body;
    body = &quot;&quot;;
 
    while( 1 ) {
      tmp = recv_line( socket:socket, length:4096 );
      l = hex2dec( xvalue:tmp );
      body = strcat( body, recv( socket:socket, length:l, min:l ) );
      # &quot;\r\n&quot;
      recv( socket:socket, length:2, min:2 );
      if( l == 0 ) {
        return( body ); # This is expected - don&#39;t put this line before the previous
      }
    }
  }

  if( length ) max = length;
  if( l &gt;= 0 ) min = int( l );
  if( l &gt;= max || min &gt;= max ) max = l;
  if( max &lt; 0 ) {
    #display(&quot;http_recv_body: bogus or no Content-length field, and no &#39;length&#39; paramater set! Defaulting to 8 KB\n&quot;);
    max = 8192;
  }
  #display(&quot;http_recv_body: min=&quot;, min, &quot;; max=&quot;, max, &quot;\n&quot;);
  if( min &gt; 0 ) {
    x = recv( socket:socket, length:max, min:min );
  } else {
    n = recv( socket:socket, min:max, length:max );
    x = n;
    while( strlen( n ) &gt;= max &amp;&amp; max != 0 ) {
      n = recv( socket:socket, length:max );
      x += n;
      if( strlen( x ) &gt; 1048576 ) {
        display( &quot;http_recv_body: read stopped after 1 MB!\n&quot; );
        break;
      }
    }
  }

  if( gzip ) return http_gunzip( buf:x, onlybody:FALSE );

  return( x );
}

# This function reads everything

		</pre> <a href="#top">top</a> <hr> <h2 id="http_recv_headers2">http_recv_headers2</h2> <h3>Named Parameters</h3> <dl> <dt>socket</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_recv_headers2( socket ) {

  local_var buf, line, counter;

  if( ! socket ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#socket#-#http_recv_headers2&quot; );

  while( TRUE ) {
    counter ++;
    line = recv_line( socket:socket, length:4096 );
    buf += line;
    if( line == &#39;\r\n&#39; ) break;
    if( ! strlen( line ) ) break;
    if( counter &gt; 1024 ) break;
  }

  return buf;
}

# This function does not return the headers!

		</pre> <a href="#top">top</a> <hr> <h2 id="http_recv_length">http_recv_length</h2> <h3>Named Parameters</h3> <dl> <dt>bodylength</dt> <dt>socket</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_recv_length( socket, bodylength ) {

  local_var h, b;

  if( ! socket ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#socket#-#http_recv_length&quot; );
  if( ! bodylength ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#bodylength#-#http_recv_length&quot; );

  h = http_recv_headers2( socket:socket );
  b = http_recv_body( socket:socket, headers:h, length:bodylength );
  return strcat( h, &#39;\r\n&#39;, b );
}

function http_send_recv( port, data ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="http_send_recv">http_send_recv</h2> <h3>Named Parameters</h3> <dl> <dt>data</dt> <dt>port</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function http_send_recv( port, data ) {

  local_var s, r;

  if( ! port ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#port#-#http_send_recv&quot; );
  if( ! data ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#data#-#http_send_recv&quot; );

  s = http_open_socket( port );
  if( ! s ) return;
  send( socket:s, data:data );
  while( x = http_recv( socket:s ) ) {
    if( &quot;content-length:&quot; &gt;&lt; tolower( x ) &amp;&amp; &quot;206 Partial&quot; &gt;!&lt; x ) {
      cl = eregmatch( pattern:&quot;Content-Length: ([0-9]+)&quot;, string:x, icase:TRUE );
      if( ! isnull( cl[1] ) ) conlen = int( cl[1] );
    }

    r += x;
    if( ( conlen  &amp;&amp; conlen &gt; 0 ) &amp;&amp; strlen( r ) &gt;= conlen ) break;

  }

  http_close_socket( s );

  if( &quot;content-encoding: gzip&quot; &gt;&lt; tolower( r ) )
    return http_gunzip( buf:r );

  return r;

}

function cgi_dirs( port ) {

		</pre> <a href="#top">top</a> <hr> <h2 id="make_list_unique">make_list_unique</h2> <h3>Named Parameters</h3> <dl> </dl> <h3>Code</h3> <pre class="brush: nasl">
function make_list_unique( ) {

  local_var ret, args, x, z, a, e;

  ret = make_list();
  args = make_list();

  foreach x( _FCT_ANON_ARGS ) {
    if( typeof( x ) == &quot;array&quot; ) { # e.g. return value from cgi_dirs()
      foreach z( x )
        args = make_list( args, z );
    } else {
      args = make_list( args, x );
    }
  }

  foreach a( args ) {

    e = FALSE;
    foreach r ( ret ) {
      if( a == r ) {
        e = TRUE; # entry already exist
        break;
      }
    }

    if( ! e ) ret = make_list( ret, a ); # entry didn&#39;t exist, add entry...
  }
  return ret;
}


		</pre> <a href="#top">top</a> <hr> <h2 id="php_ver_match">php_ver_match</h2> <h3>Named Parameters</h3> <dl> <dt>banner</dt> <dt>pattern</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function php_ver_match( banner, pattern ) {

  local_var line;

  if( ! banner ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#banner#-#php_ver_match&quot; );
  if( ! pattern ) set_kb_item( name: &quot;nvt_debug_empty/&quot; + get_script_oid(), value:get_script_oid() + &quot;#-#pattern#-#php_ver_match&quot; );

  line = egrep( pattern:&quot;^Server:.*&quot;, string:banner, icase:TRUE );

  if( ereg( pattern:pattern, string:line, icase:TRUE ) ) {
    return( 1 );
  } else {
    line = egrep( pattern:&quot;^X-Powered-By:.*&quot;, string:banner, icase:TRUE );
    if( ereg( pattern:pattern, string:line, icase:TRUE ) ) {
      return( 1 );
    }
  }
  return( 0 );
}

function http_is_dead( port, retry ) {

		</pre> <a href="#top">top</a> <hr> <h1>Private Function Details</h1> <h2 id="__hex_value">__hex_value</h2> <h3>Named Parameters</h3> <dl> <dt>num</dt> </dl> <h3>Code</h3> <pre class="brush: nasl">
function __hex_value( num ) {

  if( num == &quot;a&quot;) return( 10 );
  if( num == &quot;b&quot;) return( 11 );
  if( num == &quot;c&quot;) return( 12 );
  if( num == &quot;d&quot;) return( 13 );
  if( num == &quot;e&quot;) return( 14 );
  if( num == &quot;f&quot;) return( 15 );
  return( int( num ) );
}

function hex2dec( xvalue ) {

		</pre> <a href="#top">top</a> <hr> </div> </div> <hr> <footer> <p>&copy; Tenable Network Security 2014</p> </footer> </div> <script type="text/javascript" src="js/jquery-1.8.2.js"></script> <script type="text/javascript" src="js/bootstrap.min.js"></script> <script type="text/javascript" src="js/shCore.js"></script> <script type="text/javascript" src="js/shBrushNasl.js"></script> <script type="text/javascript">
    SyntaxHighlighter.defaults['collapse'] = true;
    SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.all();
  </script> </body> </html>