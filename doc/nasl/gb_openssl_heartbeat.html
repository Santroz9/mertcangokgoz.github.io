



<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <title>nasldoc: nasl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Le styles -->
  <style type="text/css">
	body {
	padding-top: 60px;
	padding-bottom: 40px;
	}
	.sidebar-nav {
	padding: 9px 0;
	}
  </style>

  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/shCore.css" rel="stylesheet" type="text/css" />
  <link href="css/shThemeDefault.css" rel="stylesheet" type="text/css" />

  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- Fav and touch icons -->
  <link rel="shortcut icon" href="ico/favicon.ico">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
  <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
  </head>

  <body>

	<div class="navbar navbar-inverse navbar-fixed-top">
	  <div class="navbar-inner">
		<div class="container-fluid">
		  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
		  </a>
		  <a class="brand" href="index.html">nasldoc</a>
		  <div class="nav-collapse collapse">
			<ul class="nav">
			  <li class="active"><a href="index.html">Home</a></li>
			</ul>
		  </div><!--/.nav-collapse -->
		</div>
	  </div>
	</div>

  <div class="container-fluid">
	<div class="row-fluid">
	<div class="span3">
	  <div class="well sidebar-nav">
	  <ul class="nav nav-list">
		
			
			
			<li class="even">
			  <a href="GSHB_BruteForce.html">GSHB_BruteForce.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="GSHB_read_file.html">GSHB_read_file.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="bad_ssh_host_keys.html">bad_ssh_host_keys.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="bad_ssh_keys.html">bad_ssh_keys.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="bin.html">bin.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="byte_func.html">byte_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="cisco_ios.html">cisco_ios.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="cpe.html">cpe.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="default_account.html">default_account.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="default_credentials.html">default_credentials.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="dump.html">dump.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="ftp_func.html">ftp_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="gb_openssl_heartbeat.html">gb_openssl_heartbeat.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="global_settings.html">global_settings.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="gvr_apps_auth_func.html">gvr_apps_auth_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="host_details.html">host_details.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="hp_printers.html">hp_printers.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="http_func.html">http_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="http_keepalive.html">http_keepalive.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="imap_func.html">imap_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="itg.html">itg.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="junos.html">junos.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="kyocera_printers.html">kyocera_printers.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="ldap.html">ldap.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="lexmark_printers.html">lexmark_printers.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="misc_func.html">misc_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="netop.html">netop.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="network_func.html">network_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="nfs_func.html">nfs_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="nmap.html">nmap.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="nntp_func.html">nntp_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="os_eol.html">os_eol.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="pingpong.html">pingpong.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="pkg-lib-bsd.html">pkg-lib-bsd.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="pkg-lib-deb.html">pkg-lib-deb.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="pkg-lib-gentoo.html">pkg-lib-gentoo.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="pkg-lib-hpux.html">pkg-lib-hpux.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="pkg-lib-macosx.html">pkg-lib-macosx.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="pkg-lib-rpm.html">pkg-lib-rpm.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="pkg-lib-slack.html">pkg-lib-slack.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="pop3_func.html">pop3_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="revisions-lib.html">revisions-lib.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="rsync_func.html">rsync_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="secpod_activex.html">secpod_activex.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="secpod_ie_supersede.html">secpod_ie_supersede.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="secpod_reg.html">secpod_reg.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="secpod_smb_func.html">secpod_smb_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="secpod_ssl_ciphers.html">secpod_ssl_ciphers.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="sharp_printers.html">sharp_printers.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="sip.html">sip.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="smb_default_credentials.html">smb_default_credentials.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="smb_nt.html">smb_nt.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="smbcl_func.html">smbcl_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="smtp_func.html">smtp_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="snmp_func.html">snmp_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="solaris.html">solaris.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="ssh_func.html">ssh_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="ssl_funcs.html">ssl_funcs.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="telnet_func.html">telnet_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="tftp.html">tftp.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="uddi.html">uddi.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="url_func.html">url_func.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="version_func.html">version_func.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="vmware_esx.html">vmware_esx.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="wmi_file.html">wmi_file.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="wmi_hardware.html">wmi_hardware.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="wmi_misc.html">wmi_misc.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="wmi_os.html">wmi_os.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="wmi_proc.html">wmi_proc.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="wmi_rsop.html">wmi_rsop.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="wmi_svc.html">wmi_svc.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="wmi_user.html">wmi_user.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="wordlist.html">wordlist.inc</a>
			</li>
		
			
			
			<li class="odd">
			  <a href="xerox_printers.html">xerox_printers.inc</a>
			</li>
		
			
			
			<li class="even">
			  <a href="xml.html">xml.inc</a>
			</li>
		
	  </ul>
	  </div><!--/.well -->
	</div><!--/span-->
	<div class="span9">

		<a name="top"></a>
		<h1>Overview of gb_openssl_heartbeat.inc</h1>
		

		

		
		
		
		
		

		
		
		<h1>Public Function Summary</h1>

		
		<p>Public functions are intended to be called by the code that imports
		this library.</p>
		

		<table class="nopad">
		  <tr class="TableHeadingColor">
			<th>Name</th>
			<th>Summary</th>
		  </tr>
		  
		  <tr>
			<td><a href="#heartbeat_supported">heartbeat_supported</a></td>
			<td></td>
		  </tr>
		  
		  <tr>
			<td><a href="#open_socket">open_socket</a></td>
			<td></td>
		  </tr>
		  
		  <tr>
			<td><a href="#test_hb">test_hb</a></td>
			<td></td>
		  </tr>
		  
		</table>
		
		
		
		<h1>Private Function Summary</h1>

		
		<p>Private functions are not intended to be called by the code that
		imports this library. There is no functional difference between private
		and public functions, only convention, and they may be called as
		normal. </p>
		

		<table class="nopad">
		  <tr class="TableHeadingColor">
			<th>Name</th>
			<th>Summary</th>
		  </tr>
		  
		  <tr>
			<td><a href="#_broken_heartbeat">_broken_heartbeat</a></td>
			<td></td>
		  </tr>
		  
		</table>
		
		

		
		
		
		
		

		
		
		<h1>Public Function Details</h1>
		
		<h2 id="heartbeat_supported">heartbeat_supported</h2>
		

		

		
		<h3>Named Parameters</h3>
		<dl>

		
			<dt>data</dt>
			
		
		</dl>
		

		

		<h3>Code</h3>
                <!-- The contents must not have indentation, else formatting is off. -->
		<pre class="brush: nasl">
function heartbeat_supported( data )
{
  local_var pos, data, i, typ, heartbeat_mode, extension_length, session_id_length, handshake_length;

  if( ! data ) return FALSE;
 
  pos = 1;

  for( i = 0; i &lt; strlen( data ); i++ )
  {
    handshake_length = strlen( data );
    if( handshake_length &lt; 43 ) return FALSE;
    pos += 37;

    session_id_length = ord( data[pos] );
    pos += session_id_length + 4;

    if( pos  &gt; handshake_length ) return FALSE;

    extension_length = getword( blob:data, pos:pos );
    if( extension_length &lt; 1 ) return FALSE; 
    pos += 2;

    for( j=0; j &lt; extension_length; j++ )
    {
      if( ( pos + j  + 4 ) &gt; handshake_length ) return FALSE; 

      typ = getword( blob:data, pos:pos + j );

      if ( typ == 0x0f )
      {
        heartbeat_mode = ord( data[ pos + j + 4 ] );
        if( heartbeat_mode == 1 ) return TRUE; 
      }    
    }

  } 
  return FALSE;
}



		</pre>
		<a href="#top">top</a>
		<hr>
		
		<h2 id="open_socket">open_socket</h2>
		

		

		
		<h3>Named Parameters</h3>
		<dl>

		
			<dt>port</dt>
			
		
		</dl>
		

		

		<h3>Code</h3>
                <!-- The contents must not have indentation, else formatting is off. -->
		<pre class="brush: nasl">
function open_socket( port )
{
  local_var soc, port, starttls_typ, starttls, st, search, stls;

  if( ! port ) return;

  soc = open_sock_tcp( port, transport:ENCAPS_IP );
  if( ! soc ) return FALSE;

  starttls_typ = get_kb_item(&#39;TLS/&#39; + port);

  if( starttls_typ )
  {
    if( starttls_typ == &quot;xmpp-server&quot; )
    {
      host = get_host_name();

      req = &quot;&lt;stream:stream xmlns=&#39;jabber:server&#39; &quot; +
      &quot;xmlns:stream=&#39;http://etherx.jabber.org/streams&#39; &quot; +
      &quot;version=&#39;1.0&#39; &quot; +
      &quot;to=&#39;&quot; + host  + &quot;&#39;&gt;&quot;;

      send( socket:soc, data:req );
      recv = recv( socket:soc, length:2048 );

      if( &quot;stream:error&quot; &gt;&lt; recv )
      {
        close( soc );
        return FALSE;
      }

      req = &quot;&lt;starttls xmlns=&#39;urn:ietf:params:xml:ns:xmpp-tls&#39;/&gt;&quot;;
      send( socket:soc, data:req );
      recv = recv( socket:soc, length:256 );

      if( &quot;&lt;proceed&quot; &gt;!&lt; recv )
      {
        close( soc );
        return FALSE;
      }
    }
    else if( starttls_typ == &quot;xmpp-client&quot; )
    {
      host = get_host_name();

      req = &quot;&lt;stream:stream xmlns=&#39;jabber:client&#39; &quot; +
      &quot;xmlns:stream=&#39;http://etherx.jabber.org/streams&#39; &quot; +
      &quot;version=&#39;1.0&#39; &quot; +
      &quot;to=&#39;&quot; + host  + &quot;&#39;&gt;&quot;;

      send( socket:soc, data:req );
      recv = recv( socket:soc, length:2048 );

      if( &quot;stream:error&quot; &gt;&lt; recv )
      {
        close( soc );
        return FALSE;
      }

      req = &quot;&lt;starttls xmlns=&#39;urn:ietf:params:xml:ns:xmpp-tls&#39;/&gt;&quot;;
      send( socket:soc, data:req );
      recv = recv( socket:soc, length:256 );

      if( &quot;&lt;proceed&quot; &gt;!&lt; recv )
      {
        close( soc );
        return FALSE;
      }
    }
    else if ( starttls_typ == &quot;ldap&quot; )
    {
      req = raw_string(0x30,0x1d,0x02,0x01,0x01,0x77,0x18,0x84,
                       0x16,0x31,0x2e,0x33,0x2e,0x36,0x2e,0x31,
                       0x2e,0x34,0x2e,0x31,0x2e,0x31,0x34,0x36,
                       0x36,0x2e,0x32,0x30,0x30,0x33,0x37);

      send(socket:soc, data:req);
      recv = recv(socket:soc, length:1024);

      if( ord( recv[0] ) != 48 )
      {
        close( soc );
        return FALSE;
      }    
    }  
    else
    {
      tls_str = make_array(
                         &#39;smtp&#39;, &#39;220:STARTTLS\r\n&#39; ,
                         &#39;imap&#39;, &#39;OpenVAS1 OK:OpenVAS1 STARTTLS\r\n&#39;,
                         &#39;pop3&#39;, &#39;+OK:STLS\r\n&#39;,
                         &#39;ftp&#39;,  &#39;234:AUTH TLS\r\n&#39;,
                         &#39;postgres&#39;,&#39;S:&#39; + raw_string(0x00,0x00,0x00,0x08,0x04,0xD2,0x16,0x2F),
                         &#39;nntp&#39;, &#39;382 Continue:STARTTLS\r\n&#39;
                        );

      if(  tls_str[starttls_typ] ) 
      { 
        starttls = tls_str[starttls_typ];

        if( starttls_typ == &#39;smtp&#39; )
        {
           recv( socket:soc, length:1024 );
           send( socket:soc, data:&#39;EHLO &#39; + this_host() + &#39;\r\n&#39;);
           recv = recv( socket:soc, length:1024 );
        }

        st = split( starttls, sep:&quot;:&quot;, keep:FALSE );
        search = st[0];
        stls =  st[1];

        if( isnull( search ) || isnull( stls ) ) return  FALSE;
  
        send(socket:soc, data:stls);
        recv = recv( socket:soc, length:1024 );

        if( search &gt;!&lt; recv )
        { 
          close( soc );
          return FALSE;
        } 

      }  

    }

  }

  if( ! soc ) return;

  return soc;

}

function heartbeat_supported( data )

		</pre>
		<a href="#top">top</a>
		<hr>
		
		<h2 id="test_hb">test_hb</h2>
		

		

		
		<h3>Named Parameters</h3>
		<dl>

		
			<dt>port</dt>
			
		
			<dt>version</dt>
			
		
		</dl>
		

		

		<h3>Code</h3>
                <!-- The contents must not have indentation, else formatting is off. -->
		<pre class="brush: nasl">
function test_hb( port, version )
{
  local_var soc, hdr, len, pay, h, d, hello_done;

  soc = open_socket( port:port );
  if( ! soc ) return FALSE;

  hello = _ssl3_tls_hello( version:version );
  if( ! hello )
  {
    close( soc );
    return FALSE;
  }

  send( socket:soc, data:hello );

  while ( ! hello_done )
  {
    hdr = recv( socket:soc, length:5, timeout:5 );

    if( ! hdr || strlen( hdr ) != 5 )
    {
      close( soc );
      return FALSE;
    }

    len = getword( blob:hdr, pos:3 );
    pay = recv( socket:soc, length:len, timeout:5 );

    if( ! pay )
    {
      close( soc );
      return FALSE;
    }

    if( ord( pay[0] ) == 0x02 )
    {
      if( ! heartbeat_supported( data:pay ) ) return FALSE;
    }

    if( ord( pay[0] ) == 13 &amp;&amp; ord( hdr[0] ) == 22 )
    {
      len1 = getword( blob:pay, pos:2 );
      next = substr( pay, len1 + 4 );
      if( next &amp;&amp; ord( next[0] ) == 14 )
      {
        hello_done = TRUE;
        break;
      }
    }

    if( ( strlen( pay ) - 4 ) &gt; 0 )
      mult = substr( pay, ( strlen( pay ) - 4 ), strlen( pay ) );

    if( ( ord( pay[0] ) == 14 || ( mult &amp;&amp; ord( mult[0] ) == 14 ) ) &amp;&amp; ord( hdr[0] ) == 22 )
    {
      hello_done = TRUE;
      break;
    }
  }

  if( ! hello_done )
  {
    close( soc );
    return FALSE;
  }

  # send heartbeat request in two packets to 
  # work around stupid IDS which try to detect
  # attack by matching packets only
  hb = _broken_heartbeat( version:version );
  send( socket:soc, data:raw_string( 0x18 ) );
  send( socket:soc, data:hb );

  h = recv( socket:soc, length:5, timeout:5 );

  if( ! h  || strlen( h ) != 5 )
  {
    close( soc );
    return FALSE;
  }

  if( ord( h[0] ) == 21 )
  {
    close( soc );
    return FALSE;
  }

  if( ord( h[0] ) == 24 )
  {
    len = getword( blob:h, pos:3 );
    d = recv( socket:soc, length:len, timeout:10 );
    close( soc );
 
    if( strlen( d ) &gt; 3 )
    {
      security_message( port:port );
      exit( 0 );
    }
  }
  
  if( soc ) close( soc );
  return;

}

function open_socket( port )

		</pre>
		<a href="#top">top</a>
		<hr>
		
		
		
		
		<h1>Private Function Details</h1>
		
		<h2 id="_broken_heartbeat">_broken_heartbeat</h2>
		

		

		
		<h3>Named Parameters</h3>
		<dl>

		
			<dt>version</dt>
			
		
		</dl>
		

		

		<h3>Code</h3>
                <!-- The contents must not have indentation, else formatting is off. -->
		<pre class="brush: nasl">
function _broken_heartbeat( version )
{
  local_var version, hb, payload;

  if( ! version ) version = TLS_10;

  payload = raw_string( 0x01 ) + raw_string( 16384 / 256, 16384 % 256 );
  hb = version + data_len( data:payload ) + payload;

  return hb;
}

function test_hb( port, version )

		</pre>
		<a href="#top">top</a>
		<hr>
		
		
		

	</div><!--/span-->
	</div><!--/row-->

	<hr>

	<footer>
		<p>&copy; Tenable Network Security 2014</p>
	</footer>

  </div><!--/.fluid-container-->

  <!-- Le javascript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script type="text/javascript" src="js/jquery-1.8.2.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/shCore.js"></script>
  <script type="text/javascript" src="js/shBrushNasl.js"></script>

  <script type="text/javascript">
    SyntaxHighlighter.defaults['collapse'] = true;
    SyntaxHighlighter.defaults['gutter'] = false;
    SyntaxHighlighter.all();
  </script>

  </body>
</html>
